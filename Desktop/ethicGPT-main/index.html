<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EthicBot - AI Ethics & Shopping Assistant</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="shopping-models.js"></script>
    
    <!-- 
    üåê LOCALHOST SETUP INSTRUCTIONS:
    
    QUICK START:
    1. Open Terminal/Command Prompt
    2. cd /Users/apple/Desktop/ethicGPT-main
    3. python3 -m http.server 8000
    4. Visit: http://localhost:8000/index.html
    
    ALTERNATIVE METHODS:
    ‚Ä¢ Node.js: npx http-server -p 8000
    ‚Ä¢ PHP: php -S localhost:8000
    ‚Ä¢ VS Code: Use "Live Server" extension
    
    üöÄ AUTOMATIC SCRIPT (Save as start-server.py):
    
    #!/usr/bin/env python3
    import http.server
    import socketserver
    import webbrowser
    import os
    
    PORT = 8000
    
    class Handler(http.server.SimpleHTTPRequestHandler):
        def end_headers(self):
            self.send_header('Access-Control-Allow-Origin', '*')
            super().end_headers()
    
    os.chdir('/Users/apple/Desktop/ethicGPT-main')
    
    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        url = f"http://localhost:{PORT}/index.html"
        print(f"üöÄ EthicBot Server: {url}")
        webbrowser.open(url)
        httpd.serve_forever()
    
    üéØ Run with: python3 start-server.py
    -->
    
    <script>
        // Localhost detection and optimization
        function detectEnvironment() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                              window.location.hostname === '127.0.0.1' || 
                              window.location.hostname === '0.0.0.0' ||
                              window.location.protocol === 'file:';
            
            console.log('üåê Environment:', isLocalhost ? 'Localhost/Local File' : 'Remote Server');
            
            if (isLocalhost) {
                console.log('‚úÖ Running on localhost - Full features available');
                document.body.classList.add('localhost-mode');
            } else {
                console.log('üåê Running on remote server');
                document.body.classList.add('remote-mode');
            }
            
            return isLocalhost;
        }
        
        // Initialize environment detection
        const IS_LOCALHOST = detectEnvironment();
    <script>
        // Fetch a random joke
        async function fetchJoke() {
            try {
                const response = await fetch('https://v2.jokeapi.dev/joke/Programming?safe-mode');
                const data = await response.json();
                if (data.type === 'single') {
                    return data.joke;
                } else {
                    return `${data.setup}\n\n${data.delivery}`;
                }
            } catch (error) {
                console.error('Error fetching joke:', error);
                return null;
            }
        }

        // Fetch a random fact
        async function fetchFact() {
            try {
                const response = await fetch('https://uselessfacts.jsph.pl/random.json?language=en');
                const data = await response.json();
                return data.text;
            } catch (error) {
                console.error('Error fetching fact:', error);
                return null;
            }
        }

        // Fetch a random quote
        async function fetchQuote() {
            try {
                const response = await fetch('https://api.quotable.io/random');
                const data = await response.json();
                return `"${data.content}" - ${data.author}`;
            } catch (error) {
                console.error('Error fetching quote:', error);
                return null;
            }
        }

        // Fetch random user data
        async function fetchRandomUser() {
            try {
                const response = await fetch('https://randomuser.me/api/');
                const data = await response.json();
                const user = data.results[0];
                return {
                    name: `${user.name.first} ${user.name.last}`,
                    email: user.email,
                    location: `${user.location.city}, ${user.location.country}`,
                    picture: user.picture.medium
                };
            } catch (error) {
                console.error('Error fetching random user:', error);
                return null;
            }
        }

        // Product recommendation generator
        function generateProductRecommendation(weather, category) {
            const recommendations = {
                'rain': {
                    'footwear': [
                        {
                            name: 'Waterproof Rain Boots',
                            description: 'Bright, light and fully waterproof boots perfect for rainy days.',
                            features: ['Ultrasoft rubber upper', 'Waterproof construction', 'Non-slip sole']
                        },
                        {
                            name: 'All-Weather Shoes',
                            description: 'Versatile shoes that keep feet dry in any weather.',
                            features: ['Water-resistant', 'Breathable material', 'Comfort padding']
                        }
                    ],
                    'clothing': [
                        {
                            name: 'Rain Jacket',
                            description: 'Lightweight and waterproof jacket for maximum protection.',
                            features: ['Sealed seams', 'Adjustable hood', 'Breathable fabric']
                        }
                    ]
                },
                'sunny': {
                    'footwear': [
                        {
                            name: 'Breathable Sneakers',
                            description: 'Light and airy sneakers perfect for warm days.',
                            features: ['Mesh upper', 'Moisture-wicking', 'Flexible sole']
                        }
                    ],
                    'clothing': [
                        {
                            name: 'UV Protection Wear',
                            description: 'Comfortable clothing with built-in sun protection.',
                            features: ['UPF 50+', 'Quick-dry fabric', 'Lightweight']
                        }
                    ]
                }
            };
            
            return recommendations[weather]?.[category] || [];
        }

        // Weather API integration
        async function fetchWeather(city = 'London') {
            try {
                const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=your-free-api-key&q=${city}&aqi=no`);
                const data = await response.json();
                return {
                    condition: data.current.condition.text.toLowerCase(),
                    temp_c: data.current.temp_c,
                    is_day: data.current.is_day
                };
            } catch (error) {
                console.error('Error fetching weather:', error);
                return null;
            }
        }

        // Thinking patterns and responses
        function generateThoughtProcess(topic) {
            const thoughts = {
                'capabilities': [
                    "Let me analyze what I can do for you...",
                    "I'm designed to assist with several areas:",
                    "‚Ä¢ Knowledge sharing and analysis",
                    "‚Ä¢ Creative problem-solving",
                    "‚Ä¢ Data interpretation",
                    "‚Ä¢ Interactive learning through trivia",
                    "‚Ä¢ Information gathering from various sources"
                ],
                'analysis': [
                    "Hmm, let me think about this...",
                    "Analyzing the question from multiple angles:",
                    "1. Initial understanding",
                    "2. Context consideration",
                    "3. Relevant information gathering",
                    "4. Synthesizing a response"
                ],
                'learning': [
                    "That's an interesting point...",
                    "Let me process this information...",
                    "I'm connecting this with my existing knowledge..."
                ]
            };
            return thoughts[topic] || thoughts['analysis'];
        }

        // Debounce mechanism
        let isProcessing = false;
        let lastResponseTime = 0;
        const RESPONSE_COOLDOWN = 1000; // 1 second cooldown

        // Response history to prevent duplicates
        const recentResponses = new Set();
        const MAX_RECENT_RESPONSES = 5;

        function addToRecentResponses(response) {
            recentResponses.add(response);
            if (recentResponses.size > MAX_RECENT_RESPONSES) {
                recentResponses.delete(recentResponses.values().next().value);
            }
        }

        // AI Ethics Knowledge Base - Separate from product data
        const ethicsKnowledgeBase = {
            definition: {
                ethics: "Ethics is the branch of philosophy that deals with moral principles and values that govern behavior. In the context of AI, it focuses on ensuring technology serves humanity responsibly.",
                ai_ethics: "AI Ethics is a set of values, principles, and techniques that employ widely accepted standards of right and wrong to guide moral conduct in the development and use of AI technologies."
            },
            principles: {
                fairness: "AI systems should treat all individuals and groups equitably, without bias or discrimination.",
                transparency: "AI decision-making processes should be understandable and explainable to users.",
                accountability: "Clear responsibility must be established for AI system outcomes and decisions.",
                privacy: "Personal data must be protected and used only with proper consent and safeguards.",
                beneficence: "AI should be designed to benefit humanity and avoid harm.",
                autonomy: "AI should respect human agency and decision-making capabilities."
            },
            challenges: {
                bias: "Algorithmic bias occurs when AI systems produce unfair or discriminatory results based on race, gender, age, or other characteristics.",
                privacy_concerns: "AI systems often require vast amounts of personal data, raising concerns about surveillance and data misuse.",
                job_displacement: "Automation through AI may eliminate certain jobs, requiring societal adaptation and retraining programs.",
                decision_transparency: "Many AI systems, especially deep learning models, operate as 'black boxes' making their decisions difficult to understand.",
                accountability_gaps: "When AI systems make harmful decisions, it can be unclear who is responsible - the developer, user, or the AI itself."
            },
            applications: {
                healthcare: "AI in medical diagnosis must balance accuracy with patient privacy and avoid bias in treatment recommendations.",
                finance: "AI credit scoring and loan approval systems must be fair and not discriminate against protected groups.",
                criminal_justice: "AI risk assessment tools must be transparent and not perpetuate existing biases in the justice system.",
                autonomous_vehicles: "Self-driving cars must make ethical decisions in unavoidable accident scenarios.",
                social_media: "AI content moderation must balance free speech with preventing harm and misinformation."
            }
        };

        // Intelligent response generator for ethics questions
        function generateEthicsResponse(input) {
            const lowerInput = input.toLowerCase();
            
            // Define what ethics is
            if (lowerInput.includes('what is ethics') || lowerInput.includes('define ethics')) {
                return `Ethics is ${ethicsKnowledgeBase.definition.ethics}\n\n` +
                       `In AI, ethics becomes crucial because:\n` +
                       `‚Ä¢ AI systems can impact millions of people\n` +
                       `‚Ä¢ Decisions made by AI can have life-changing consequences\n` +
                       `‚Ä¢ AI can perpetuate or amplify existing societal biases\n` +
                       `‚Ä¢ The complexity of AI makes accountability challenging\n\n` +
                       `Key ethical principles in AI include fairness, transparency, accountability, privacy, and beneficence.`;
            }
            
            // AI Ethics definition
            if (lowerInput.includes('ai ethics') || (lowerInput.includes('ai') && lowerInput.includes('ethics'))) {
                return `${ethicsKnowledgeBase.definition.ai_ethics}\n\n` +
                       `The core principles of AI Ethics are:\n\n` +
                       Object.entries(ethicsKnowledgeBase.principles).map(([key, value]) => 
                           `‚Ä¢ **${key.charAt(0).toUpperCase() + key.slice(1)}**: ${value}`
                       ).join('\n\n') +
                       `\n\nWould you like me to explore any of these principles in detail?`;
            }
            
            // Specific principle explanations
            for (const [principle, explanation] of Object.entries(ethicsKnowledgeBase.principles)) {
                if (lowerInput.includes(principle)) {
                    return `**${principle.charAt(0).toUpperCase() + principle.slice(1)} in AI Ethics:**\n\n` +
                           `${explanation}\n\n` +
                           `This principle is crucial because it helps ensure AI systems are developed and deployed responsibly, ` +
                           `protecting individuals and society from potential harm while maximizing benefits.`;
                }
            }
            
            // Challenges and issues
            if (lowerInput.includes('challenge') || lowerInput.includes('problem') || lowerInput.includes('issue')) {
                return `Major challenges in AI Ethics include:\n\n` +
                       Object.entries(ethicsKnowledgeBase.challenges).map(([key, value]) => 
                           `‚Ä¢ **${key.replace('_', ' ').charAt(0).toUpperCase() + key.replace('_', ' ').slice(1)}**: ${value}`
                       ).join('\n\n') +
                       `\n\nThese challenges require ongoing attention from researchers, policymakers, and society as a whole.`;
            }
            
            return null; // Return null if no ethics-specific response needed
        }
            history: [],
            topics: new Set(),
            lastContext: null,
            maxHistory: 5
        };

        // Knowledge base for AI ethics and related topics
        const knowledgeBase = {
            'ai_ethics': {
                principles: [
                    'Fairness and non-discrimination',
                    'Transparency and explainability',
                    'Privacy and data protection',
                    'Accountability and responsibility',
                    'Safety and security'
                ],
                challenges: [
                    'Algorithmic bias',
                    'Data privacy concerns',
                    'Ethical decision making',
                    'Transparency vs performance',
                    'Accountability in AI systems'
                ],
                applications: [
                    'Healthcare AI ethics',
                    'Autonomous vehicles',
                    'AI in criminal justice',
                    'Financial AI systems',
                    'AI in social media'
                ]
            },
            'machine_learning': {
                concepts: [
                    'Neural networks',
                    'Deep learning',
                    'Supervised learning',
                    'Unsupervised learning',
                    'Reinforcement learning'
                ],
                applications: [
                    'Natural language processing',
                    'Computer vision',
                    'Speech recognition',
                    'Recommendation systems',
                    'Autonomous systems'
                ]
            }
        };

        // Natural language understanding patterns
        const nlpPatterns = {
            greetings: ['hello', 'hi', 'hey', 'greetings'],
            questions: ['what', 'how', 'why', 'when', 'where', 'can', 'could'],
            topics: ['ai', 'ethics', 'machine learning', 'privacy', 'data', 'algorithm'],
            sentiment: {
                positive: ['good', 'great', 'excellent', 'amazing', 'helpful'],
                negative: ['bad', 'poor', 'wrong', 'issue', 'problem']
            }
        };

        // Advanced AI Response System
        async function generateResponse(userInput) {
            const input = userInput.toLowerCase();
            
            // Prevent rapid-fire responses
            const now = Date.now();
            if (isProcessing || (now - lastResponseTime) < RESPONSE_COOLDOWN) {
                return null;
            }

            isProcessing = true;
            lastResponseTime = now;

            try {
                // Generate intelligent response
                const response = await generateAIResponse(userInput);
                isProcessing = false;
                return response;
            } catch (error) {
                console.error('Error generating response:', error);
                isProcessing = false;
                return "I apologize, but I'm having trouble processing that request. Could you try rephrasing your question?";
            }
        }

        // Advanced AI Response System using Free APIs
        async function generateAIResponse(userInput) {
            const input = userInput.toLowerCase();
            
            // Try multiple free AI APIs for ChatGPT-like responses
            try {
                // Option 1: Use HuggingFace's free conversational AI
                const hfResponse = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: userInput,
                        parameters: {
                            max_length: 150,
                            temperature: 0.7,
                            return_full_text: false
                        }
                    })
                });
                
                if (hfResponse.ok) {
                    const data = await hfResponse.json();
                    if (data && data[0] && data[0].generated_text) {
                        // Clean up the response
                        let response = data[0].generated_text.trim();
                        if (response && response.length > 10) {
                            return response;
                        }
                    }
                }
            } catch (error) {
                console.log('HuggingFace API unavailable');
            }

            // Option 2: Try Cohere's free trial API (if available)
            try {
                const cohereResponse = await fetch('https://api.cohere.ai/v1/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer TRIAL-KEY' // Free trial key
                    },
                    body: JSON.stringify({
                        model: 'command-light',
                        prompt: `Human: ${userInput}\nAI:`,
                        max_tokens: 100,
                        temperature: 0.7
                    })
                });
                
                if (cohereResponse.ok) {
                    const data = await cohereResponse.json();
                    if (data && data.generations && data.generations[0]) {
                        return data.generations[0].text.trim();
                    }
                }
            } catch (error) {
                console.log('Cohere API unavailable');
            }
            
            // Fallback to enhanced local intelligence
            return generateLocalAIResponse(input);
        }

        // Local AI-like response generation
        function generateLocalAIResponse(input) {
            // Ethics and AI knowledge base responses
            if (input.includes('what is ethics') || input.includes('define ethics')) {
                return "Ethics is the branch of philosophy concerned with moral principles that govern behavior and decision-making. It explores questions of right and wrong, good and bad, and what we ought to do.\n\n" +
                       "**Key aspects of ethics include:**\n\n" +
                       "‚Ä¢ **Moral Philosophy**: Understanding fundamental principles of right and wrong\n" +
                       "‚Ä¢ **Applied Ethics**: How these principles work in real-world situations\n" +
                       "‚Ä¢ **Consequentialism**: Judging actions by their outcomes\n" +
                       "‚Ä¢ **Deontological Ethics**: Focusing on duties and rules\n" +
                       "‚Ä¢ **Virtue Ethics**: Emphasizing character and moral virtues\n\n" +
                       "In the context of AI and technology, ethics becomes crucial for ensuring that our technological advances benefit humanity while minimizing harm. Would you like me to explore how ethics applies specifically to artificial intelligence?";
            }
            
            if (input.includes('hello') || input.includes('hi') || input.includes('hey')) {
                const greetings = [
                    "Hello! I'm an AI assistant specialized in ethics and technology. How can I help you today?",
                    "Hi there! I'm here to discuss AI ethics, technology principles, and answer your questions thoughtfully.",
                    "Greetings! I'm an intelligent assistant focused on ethical AI and responsible technology. What would you like to explore?"
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }
            
            if (input.includes('ai ethics') || (input.includes('ai') && input.includes('ethics'))) {
                return "AI Ethics is a multidisciplinary field that examines the moral implications of artificial intelligence systems. It addresses how we can develop and deploy AI responsibly.\n\n" +
                       "**Core principles include:**\n\n" +
                       "‚Ä¢ **Fairness**: Ensuring AI systems don't discriminate and treat all users equitably\n" +
                       "‚Ä¢ **Transparency**: Making AI decision-making processes understandable and explainable\n" +
                       "‚Ä¢ **Accountability**: Establishing clear responsibility for AI outcomes\n" +
                       "‚Ä¢ **Privacy**: Protecting personal data and respecting user rights\n" +
                       "‚Ä¢ **Beneficence**: Designing AI to benefit humanity and minimize harm\n" +
                       "‚Ä¢ **Human Autonomy**: Preserving human agency and decision-making power\n\n" +
                       "These principles help guide the development of AI systems that are not only powerful but also trustworthy and aligned with human values. Which aspect would you like to explore further?";
            }
            
            if (input.includes('what') && input.includes('can') && input.includes('you')) {
                return "I'm an advanced AI assistant capable of:\n\n" +
                       "üß† **Thoughtful Analysis**: I can analyze complex topics and provide nuanced perspectives\n" +
                       "üéØ **Ethics Expertise**: Deep knowledge of AI ethics, technology principles, and moral philosophy\n" +
                       "üí° **Creative Problem Solving**: Generate solutions and explore different viewpoints\n" +
                       "üìö **Knowledge Synthesis**: Combine information from multiple sources to provide comprehensive answers\n" +
                       "ü§ù **Interactive Learning**: Engage in meaningful conversations and adapt to your interests\n\n" +
                       "I can also provide:\n" +
                       "‚Ä¢ Jokes and entertainment content\n" +
                       "‚Ä¢ Random facts and trivia questions\n" +
                       "‚Ä¢ Inspirational quotes\n" +
                       "‚Ä¢ Weather-based recommendations\n\n" +
                       "What specific topic would you like to explore together?";
            }
            
            // Handle other common requests
            if (input.includes('joke') || input.includes('funny')) {
                return fetchJoke();
            }
            
            if (input.includes('fact')) {
                return fetchFact();
            }
            
            if (input.includes('quote')) {
                return fetchQuote();
            }
            
            // Default intelligent response
            return analyzeAndRespond(input);
        }

        function analyzeAndRespond(input) {
            // Analyze input for context and generate appropriate response
            const keywords = input.split(' ').filter(word => word.length > 3);
            const isQuestion = input.includes('?') || input.startsWith('what') || input.startsWith('how') || input.startsWith('why');
            
            if (isQuestion) {
                return `That's a thoughtful question about "${input}". Let me provide you with a comprehensive analysis.\n\n` +
                       `From what I understand, this touches on several important concepts. Let me break this down:\n\n` +
                       `**Key considerations:**\n` +
                       `‚Ä¢ Context and background of the topic\n` +
                       `‚Ä¢ Multiple perspectives and viewpoints\n` +
                       `‚Ä¢ Practical implications and applications\n` +
                       `‚Ä¢ Ethical considerations if applicable\n\n` +
                       `Could you help me understand what specific aspect interests you most? This will help me provide a more targeted and useful response.`;
            } else {
                return `I see you're interested in "${input}". This is a fascinating topic that can be approached from various angles.\n\n` +
                       `Let me share some initial thoughts:\n\n` +
                       `This subject involves multiple dimensions that are worth exploring, including its practical applications, theoretical foundations, and potential implications for society.\n\n` +
                       `What specific questions do you have about this topic? I'd be happy to dive deeper into any particular aspect that interests you.`;
            }
        }
            
            // Input analysis functions
            function analyzeInput(input) {
                const words = input.split(' ');
                const context = {
                    type: 'unknown',
                    topics: [],
                    sentiment: 'neutral',
                    isQuestion: false,
                    keywords: new Set()
                };

                // Detect input type
                if (nlpPatterns.greetings.some(g => input.includes(g))) {
                    context.type = 'greeting';
                }
                if (nlpPatterns.questions.some(q => input.includes(q))) {
                    context.type = 'question';
                    context.isQuestion = true;
                }

                // Extract topics and keywords
                words.forEach(word => {
                    if (nlpPatterns.topics.includes(word)) {
                        context.topics.push(word);
                        context.keywords.add(word);
                    }
                });

                // Analyze sentiment
                if (nlpPatterns.sentiment.positive.some(p => input.includes(p))) {
                    context.sentiment = 'positive';
                } else if (nlpPatterns.sentiment.negative.some(n => input.includes(n))) {
                    context.sentiment = 'negative';
                }

                return context;
            }

            // Context management
            function updateConversationContext(context) {
                conversationContext.history.push(context);
                if (conversationContext.history.length > conversationContext.maxHistory) {
                    conversationContext.history.shift();
                }
                context.topics.forEach(topic => conversationContext.topics.add(topic));
                conversationContext.lastContext = context;
            }

            // Sophisticated response generation
            async function generateContextualResponse(input, context) {
                let response = '';
                
                // Handle different types of inputs
                if (context.type === 'greeting') {
                    const previousInteraction = conversationContext.history.length > 1;
                    response = previousInteraction ? 
                        "Welcome back! How can I help you further with " + Array.from(conversationContext.topics).join(', ') + "?" :
                        "Hello! I'm an AI assistant specialized in AI ethics and technology. How can I help you today?";
                }
                else if (context.type === 'question') {
                    if (context.topics.includes('ai') || context.topics.includes('ethics')) {
                        const relevantPrinciples = knowledgeBase.ai_ethics.principles
                            .filter(p => context.keywords.size === 0 || Array.from(context.keywords).some(k => p.toLowerCase().includes(k)));
                        
                        response = `Let me analyze this from an AI ethics perspective:\n\n`;
                        response += relevantPrinciples.map((p, i) => `${i + 1}. ${p}`).join('\n');
                        response += `\n\nWould you like me to elaborate on any of these points?`;
                    }
                    else if (context.topics.includes('machine learning')) {
                        const concepts = knowledgeBase.machine_learning.concepts;
                        response = `From a machine learning perspective, here are the key concepts to consider:\n\n`;
                        response += concepts.map((c, i) => `${i + 1}. ${c}`).join('\n');
                    }
                }

                // If no specific response generated, provide a thoughtful general response
                if (!response) {
                    // Check for ethics questions first
                    if (input.includes('what is ethics') || input.includes('define ethics')) {
                        response = "Ethics is the branch of philosophy that deals with moral principles and values that govern behavior. In the context of AI, it focuses on ensuring technology serves humanity responsibly.\n\n" +
                                 "In AI, ethics becomes crucial because:\n" +
                                 "‚Ä¢ AI systems can impact millions of people\n" +
                                 "‚Ä¢ Decisions made by AI can have life-changing consequences\n" +
                                 "‚Ä¢ AI can perpetuate or amplify existing societal biases\n" +
                                 "‚Ä¢ The complexity of AI makes accountability challenging\n\n" +
                                 "Key ethical principles in AI include fairness, transparency, accountability, privacy, and beneficence.";
                    }
                    else if (input.includes('ai ethics') || (input.includes('ai') && input.includes('ethics'))) {
                        response = "AI Ethics is a set of values, principles, and techniques that employ widely accepted standards of right and wrong to guide moral conduct in the development and use of AI technologies.\n\n" +
                                 "The core principles of AI Ethics are:\n\n" +
                                 "‚Ä¢ **Fairness**: AI systems should treat all individuals and groups equitably, without bias or discrimination.\n\n" +
                                 "‚Ä¢ **Transparency**: AI decision-making processes should be understandable and explainable to users.\n\n" +
                                 "‚Ä¢ **Accountability**: Clear responsibility must be established for AI system outcomes and decisions.\n\n" +
                                 "‚Ä¢ **Privacy**: Personal data must be protected and used only with proper consent and safeguards.\n\n" +
                                 "‚Ä¢ **Beneficence**: AI should be designed to benefit humanity and avoid harm.\n\n" +
                                 "Would you like me to explore any of these principles in detail?";
                    }
                    else if (input.includes('hi') || input.includes('hello') || input.includes('hey')) {
                        response = "Hello! I'm an AI Ethics Assistant. I can help you understand AI ethics principles, discuss ethical challenges in technology, and explore how we can build more responsible AI systems.\n\n" +
                                 "Feel free to ask me about:\n" +
                                 "‚Ä¢ What ethics means in AI context\n" +
                                 "‚Ä¢ Specific ethical principles like fairness or transparency\n" +
                                 "‚Ä¢ Challenges in AI ethics\n" +
                                 "‚Ä¢ Real-world applications of AI ethics\n\n" +
                                 "What would you like to explore?";
                    }
                    else {
                        response = "I'm here to help you understand AI ethics and related topics. You can ask me about ethical principles, challenges in AI development, or how ethics applies to specific technologies.\n\n" +
                                 "Try asking:\n" +
                                 "‚Ä¢ 'What is ethics?'\n" +
                                 "‚Ä¢ 'Explain AI ethics'\n" +
                                 "‚Ä¢ 'What are the challenges in AI ethics?'\n" +
                                 "‚Ä¢ Or any other ethics-related question!";
                    }
                    
                    isProcessing = false;
                    return response;
                }
            
                // Show thinking process for general capabilities
                if (input.includes('what') && input.includes('you') && (input.includes('do') || input.includes('can'))) {
                const capabilities = generateThoughtProcess('capabilities');
                response = capabilities.join('\n\n') + '\n\n' +
                    "I can help you with:\n\n" +
                    "1. ü§î Answering questions thoughtfully\n" +
                    "2. üéØ Providing random facts and knowledge\n" +
                    "3. üí° Sharing inspirational quotes\n" +
                    "4. üéÆ Playing trivia games\n" +
                    "5. üå§Ô∏è Checking weather and making recommendations\n" +
                    "6. üòÑ Telling programming jokes\n\n" +
                    "Would you like to explore any of these areas?";
                return response;
            }

            // Start with a thinking process
            const thoughts = generateThoughtProcess('analysis');
            
            // Handle different types of requests
            if (input.includes('joke') || input.includes('funny')) {
                response = await fetchJoke();
            } 
            else if (input.includes('fact') || input.includes('tell me something')) {
                response = await fetchFact();
            } 
            else if (input.includes('quote') || input.includes('inspire')) {
                response = await fetchQuote();
            }
            else if (input.includes('random person') || input.includes('user profile')) {
                const userData = await fetchRandomUser();
                if (userData) {
                    response = `Here's a random user profile:\n\n` +
                             `Name: ${userData.name}\n` +
                             `Location: ${userData.location}\n` +
                             `Email: ${userData.email}\n` +
                             `Profile Picture: ${userData.picture}`;
                }
            }
            else if (input.includes('recommend') || input.includes('suggest')) {
                const weatherData = await fetchWeather();
                const isRainy = weatherData?.condition.includes('rain') || weatherData?.condition.includes('drizzle');
                const products = generateProductRecommendation(isRainy ? 'rain' : 'sunny', 'footwear');
                
                if (products.length > 0) {
                    const product = products[0];
                    response = `Based on the current weather (${weatherData.condition}), I recommend:\n\n` +
                             `${product.name}\n` +
                             `${product.description}\n\n` +
                             `Key features:\n` +
                             product.features.map(f => `‚Ä¢ ${f}`).join('\n');
                }
            }

            if (!response) {
                response = "I can help you with various things! Try asking me for:\n\n" +
                          "‚Ä¢ A joke (say 'tell me a joke')\n" +
                          "‚Ä¢ A random fact (say 'tell me a fact')\n" +
                          "‚Ä¢ An inspiring quote (say 'show me a quote')\n" +
                          "‚Ä¢ A random user profile (say 'show random person')\n" +
                          "‚Ä¢ Product recommendations (say 'recommend something')\n" +
                          "‚Ä¢ Or try the trivia game (say 'trivia')";
            }

            return response;
        }

        // Original trivia function
        async function fetchTriviaQuestion() {
            try {
                const response = await fetch('https://opentdb.com/api.php?amount=1&category=18&type=multiple');
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    return data.results[0];
                }
            } catch (error) {
                console.error('Error fetching trivia:', error);
            }
            return null;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function displayTriviaQuestion() {
            const question = await fetchTriviaQuestion();
            if (!question) return;

            const options = shuffleArray([...question.incorrect_answers, question.correct_answer]);
            
            const triviaHtml = `
                <div class="trivia-container">
                    <div class="trivia-question">${question.question}</div>
                    <div class="trivia-options">
                        ${options.map(option => `
                            <div class="trivia-option" onclick="checkAnswer(this, '${question.correct_answer}')">${option}</div>
                        `).join('')}
                    </div>
                </div>
            `;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            messageDiv.innerHTML = `
                <div class="bot-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">
                        Here's a technology trivia question for you:
                        ${triviaHtml}
                    </div>
                </div>
            `;

            document.querySelector('#chat-messages').appendChild(messageDiv);
        }

        function checkAnswer(element, correctAnswer) {
            const options = element.parentElement.querySelectorAll('.trivia-option');
            options.forEach(option => {
                option.style.pointerEvents = 'none';
                if (option.textContent === correctAnswer) {
                    option.classList.add('correct');
                } else if (option === element) {
                    if (option.textContent !== correctAnswer) {
                        option.classList.add('incorrect');
                    }
                }
            });
        }

        // Handle user messages
        // Message queue for handling multiple requests
        const messageQueue = [];
        let isProcessingMessage = false;

        async function processMessageQueue() {
            if (isProcessingMessage || messageQueue.length === 0) return;
            
            isProcessingMessage = true;
            const message = messageQueue.shift();
            
            try {
                // Display user message
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'message user-message';
                userMessageDiv.innerHTML = `
                    <div class="user-avatar">üë§</div>
                    <div class="message-content">
                        <div class="message-text">${message}</div>
                    </div>
                `;
                document.querySelector('#chat-messages').appendChild(userMessageDiv);

                // Show thinking process
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'message bot-message thinking-process';
            thinkingDiv.innerHTML = `
                <div class="bot-avatar">ü§î</div>
                <div class="message-content">
                    <div class="message-text">
                        <div class="thinking-animation">Processing your request...</div>
                    </div>
                </div>
            `;
            document.querySelector('#chat-messages').appendChild(thinkingDiv);

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.innerHTML = `
                <div class="bot-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            document.querySelector('#chat-messages').appendChild(typingDiv);

            try {
                // Process message with NLP and context
                const processedInput = {
                    text: message.toLowerCase(),
                    tokens: message.toLowerCase().split(/\s+/),
                    entities: extractEntities(message),
                    intent: classifyIntent(message)
                };

                // Generate appropriate response
                let response;
                if (processedInput.intent === 'trivia') {
                    await displayTriviaQuestion();
                } else {
                    response = await generateResponse(message);

                    // Enhance response with contextual information
                    if (response) {
                        response = await enhanceResponseWithContext(response, processedInput);
                    }
                    
                    // Check for duplicate responses
                    if (recentResponses.has(response)) {
                        response = "I understand you're interested in this topic. Let me provide a different perspective...";
                    } else if (response) {
                        addToRecentResponses(response);
                    }
                }

                // Remove typing indicator
                typingDiv.remove();
                thinkingDiv.remove();

                if (response) {
                    // Add response with fade-in animation
                    const botMessageDiv = document.createElement('div');
                    botMessageDiv.className = 'message bot-message fade-in';
                    botMessageDiv.innerHTML = `
                        <div class="bot-avatar">ü§ñ</div>
                        <div class="message-content">
                            <div class="message-text">${response}</div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    `;
                    document.querySelector('#chat-messages').appendChild(botMessageDiv);
                }
            } catch (error) {
                console.error('Error processing message:', error);
            } finally {
                isProcessingMessage = false;
                // Process next message in queue if any
                setTimeout(processMessageQueue, 100);
            }
        }

        async function handleUserMessage(message) {
            messageQueue.push(message);
            processMessageQueue();
        }
    </script>
    <style>
        /* Message handling and animation styles */
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }

        .message {
            position: relative;
            margin-bottom: 1rem;
        }

        .message.duplicate {
            opacity: 0.7;
        }

        .message-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        /* Prevent message overlap */
        .message-content {
            position: relative;
            z-index: 1;
        }

        /* Smooth scroll for new messages */
        #chat-messages {
            scroll-behavior: smooth;
        }

        /* Thinking process styles */
        .thinking-process .message-content {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
        }

        .thinking-animation {
            position: relative;
            padding-left: 24px;
            color: #1976d2;
            font-style: italic;
        }

        .thinking-animation::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid #1976d2;
            border-radius: 50%;
            border-right-color: transparent;
            animation: think 1s linear infinite;
        }

        @keyframes think {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Additional styles for chat functionality */
        .message {
            display: flex;
            margin: 15px 0;
            align-items: flex-start;
            gap: 10px;
            animation: fadeIn 0.3s ease-in;
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .bot-message {
            flex-direction: row;
        }

        .message-content {
            max-width: 70%;
            background: var(--card-bg, #f8f9fa);
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .message-text {
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }

        .bot-avatar, .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bot-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .typing-indicator .message-content {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 8px 0;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }
        }

        /* API Provider indicator */
        #apiProvider {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            width: 100%;
            margin-top: 5px;
        }

        .api-selector label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        /* Status indicator for Gemini */
        .gemini-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .gemini-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .gemini-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Trivia Question Styles */
        .trivia-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .trivia-question {
            font-weight: 500;
            margin-bottom: 10px;
        }

        .trivia-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trivia-option {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trivia-option:hover {
            background: #f0f0f0;
        }

        .trivia-option.correct {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .trivia-option.incorrect {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        /* Dataset Upload Styles */
        .dataset-upload {
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .upload-btn {
            width: 100%;
            padding: 10px 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .upload-btn:active {
            transform: translateY(0);
        }

        .manual-upload-btn {
            width: 100%;
            padding: 8px 12px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
        }

        .manual-upload-btn:hover {
            background: linear-gradient(135deg, #5a6268 0%, #3d4449 100%);
        }

        .auto-detect-status {
            margin-bottom: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 12px;
            color: #495057;
        }

        .status-indicator i {
            font-size: 14px;
        }

        .dataset-info {
            margin-top: 8px;
            padding: 8px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            text-align: center;
        }

        .dataset-info small {
            color: #155724;
            font-weight: 500;
        }

        /* Enhanced message formatting for dataset responses */
        .message-text strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .message-text em {
            color: #6c757d;
            font-style: italic;
        }

        /* Dataset response styling */
        .bot-message .message-text {
            line-height: 1.6;
        }

        .bot-message .message-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .bot-message .message-text li {
            margin: 5px 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <h2>EthicBot</h2>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>
            
            <div class="chat-history">
                <div class="chat-item active">
                    <i class="fas fa-message"></i>
                    <span>AI Ethics Principles</span>
                </div>
                <div class="chat-item">
                    <i class="fas fa-message"></i>
                    <span>Bias in Machine Learning</span>
                </div>
                <div class="chat-item">
                    <i class="fas fa-message"></i>
                    <span>Privacy and AI</span>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="api-selector">
                    <label for="apiProvider">AI Provider:</label>
                    <select id="apiProvider" onchange="switchAPIProvider(this.value)">
                        <option value="local">Local Knowledge</option>
                        <option value="shopping">Shopping Assistant</option>
                        <option value="public">Public API (Free)</option>
                        <option value="openai">OpenAI GPT</option>
                        <option value="gemini">Google Gemini AI</option>
                        <option value="huggingface">Hugging Face</option>
                        <option value="anthropic">Anthropic Claude</option>
                    </select>
                </div>
                <div class="shopping-mode-toggle" style="margin-top: 10px;">
                    <button class="shopping-toggle-btn" onclick="toggleShoppingMode()">
                        <i class="fas fa-shopping-cart"></i> Shopping Mode: <span id="shopping-status">OFF</span>
                    </button>
                </div>
                <div class="guide-section" style="margin-top: 10px;">
                    <button class="guide-btn" onclick="showUserGuide()">
                        <i class="fas fa-question-circle"></i> User Guide
                    </button>
                </div>
                <div class="test-section" style="margin-top: 10px;">
                    <button class="test-btn-sidebar" onclick="showTestQuestions()">
                        <i class="fas fa-flask"></i> Test Questions
                    </button>
                </div>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span>AI Ethics Explorer</span>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div class="chat-header">
                <h1>EthicBot</h1>
                <p>Your AI Ethics Assistant - Exploring responsible AI development and deployment</p>
                <!-- Server Status Indicator -->
                <div id="server-status" style="font-size: 12px; margin-top: 5px; padding: 4px 10px; border-radius: 15px; display: inline-block; background: #e9ecef; color: #495057;">
                    <i class="fas fa-server"></i> <span id="server-status-text">Checking environment...</span>
                    <button id="localhost-help-btn" onclick="showLocalhostHelp()" style="margin-left: 10px; padding: 2px 8px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer;">
                        <i class="fas fa-question-circle"></i> Localhost Setup
                    </button>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="welcome-content">
                        <h3>Welcome to EthicBot!</h3>
                        <p>I'm here to help you explore the fascinating world of AI ethics. I can discuss topics like:</p>
                        <div class="topic-cards">
                            <div class="topic-card" onclick="sendPredefinedMessage('What are the fundamental principles of AI ethics?')">
                                <i class="fas fa-balance-scale"></i>
                                <h4>AI Ethics Principles</h4>
                                <p>Explore fairness, transparency, accountability, and human dignity</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('How can we detect and mitigate algorithmic bias in AI systems?')">
                                <i class="fas fa-search"></i>
                                <h4>Bias & Fairness</h4>
                                <p>Understanding and addressing discrimination in AI</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('What are the privacy risks and protection strategies for AI?')">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Privacy & Security</h4>
                                <p>Protecting personal data in AI applications</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('How do we make AI systems explainable and transparent?')">
                                <i class="fas fa-lightbulb"></i>
                                <h4>Explainable AI</h4>
                                <p>Making AI decisions interpretable and trustworthy</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('What governance frameworks exist for responsible AI?')">
                                <i class="fas fa-cogs"></i>
                                <h4>AI Governance</h4>
                                <p>Regulatory frameworks and organizational oversight</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('How do we ensure AI safety and prevent harmful outcomes?')">
                                <i class="fas fa-shield"></i>
                                <h4>AI Safety</h4>
                                <p>Robustness, alignment, and risk management</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('What are the social impacts of AI on society?')">
                                <i class="fas fa-users"></i>
                                <h4>Social Impact</h4>
                                <p>AI effects on employment, inequality, and society</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('How does AI affect human rights and dignity?')">
                                <i class="fas fa-hands-helping"></i>
                                <h4>Human Rights</h4>
                                <p>Protecting fundamental rights in AI applications</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('What ethical issues are in the dataset?')">
                                <i class="fas fa-database"></i>
                                <h4>Dataset Ethics</h4>
                                <p>Analyze ethical concerns in your specific data</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('Show me the bias analysis of the data')">
                                <i class="fas fa-chart-line"></i>
                                <h4>Bias Detection</h4>
                                <p>Identify and analyze bias patterns in dataset</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('Give me an overview of the dataset statistics')">
                                <i class="fas fa-chart-pie"></i>
                                <h4>Data Overview</h4>
                                <p>Comprehensive statistics and insights</p>
                            </div>
                            <div class="topic-card" onclick="sendPredefinedMessage('What are the recommendations for ethical improvements?')">
                                <i class="fas fa-lightbulb"></i>
                                <h4>Recommendations</h4>
                                <p>Get actionable ethics improvement suggestions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Ask EthicBot about AI ethics, bias, privacy, or responsible AI practices..."
                        rows="1"
                        onkeypress="handleKeyPress(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-footer">
                    <small>EthicBot can make mistakes. Consider checking important information about AI ethics.</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // EthicBot - AI Ethics Assistant with Gemini AI Integration
        class EthicBot {
            constructor() {
                this.currentProvider = 'local';
                this.apiKeys = {
                    gemini: '', // User will need to set this
                    openai: '',
                    anthropic: ''
                };
                this.chatHistory = [];
                this.trainingData = [];
                this.ethicsKnowledgeBase = new Map();
                this.initializeApp();
            }

            initializeApp() {
                this.setupEventListeners();
                this.loadChatHistory();
                this.checkAPIKeys();
                this.loadTrainingData();
                this.autoDetectAndLoadDataset();
            }

            async autoDetectAndLoadDataset() {
                // Try to automatically load the ethics dataset
                const csvFiles = ['productsclassified.csv', 'ethics_data.csv', 'products.csv'];
                
                for (const filename of csvFiles) {
                    try {
                        console.log(`Attempting to load ${filename}...`);
                        const response = await fetch(filename);
                        
                        if (response.ok) {
                            const csvText = await response.text();
                            const data = this.parseCSV(csvText);
                            
                            if (data.length > 0) {
                                await this.trainWithDataset(data, filename);
                                this.addAutoLoadMessage(filename, data.length);
                                console.log(`Successfully loaded ${filename} with ${data.length} entries`);
                                break; // Stop after first successful load
                            }
                        }
                    } catch (error) {
                        console.log(`Could not load ${filename}:`, error.message);
                    }
                }
            }

            addAutoLoadMessage(filename, entryCount) {
                // Add an initial message about dataset loading
                setTimeout(() => {
                    this.addMessageToChat('bot', `üéØ **Dataset Auto-Loaded Successfully!**\n\nI've automatically detected and trained with your ethics dataset: **${filename}**\n\nüìä **Dataset Statistics:**\n‚Ä¢ ${entryCount} entries processed\n‚Ä¢ Ethics knowledge base built\n‚Ä¢ Ready to answer questions about your specific data\n\nüí° **Try asking me:**\n‚Ä¢ "What ethical issues are in the dataset?"\n‚Ä¢ "Show me products with ethics concerns"\n‚Ä¢ "Analyze bias in the data"\n‚Ä¢ "What are the main ethical categories?"\n\nI'm now equipped with both general AI ethics knowledge and your specific dataset insights!`);
                }, 1000);
            }

            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => this.handleKeyPress(e));
                    messageInput.addEventListener('input', (e) => this.autoResize(e.target));
                }
                
                if (sendBtn) {
                    sendBtn.addEventListener('click', () => this.sendMessage());
                }
            }

            setupDatasetUpload() {
                // Create a hidden file input for CSV upload
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv';
                fileInput.style.display = 'none';
                fileInput.id = 'csvFileInput';
                
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                document.body.appendChild(fileInput);
                
                // Add upload button to sidebar
                this.addUploadButton();
            }

            addUploadButton() {
                const sidebar = document.querySelector('.sidebar-footer');
                if (sidebar) {
                    const uploadSection = document.createElement('div');
                    uploadSection.className = 'dataset-upload';
                    uploadSection.innerHTML = `
                        <div class="auto-detect-status">
                            <div class="status-indicator">
                                <i class="fas fa-search"></i>
                                <span>Auto-detecting ethics dataset...</span>
                            </div>
                        </div>
                        <div class="dataset-info" id="datasetInfo" style="display: none;">
                            <small>Dataset loaded: <span id="datasetCount">0</span> entries</small>
                        </div>
                        <button class="manual-upload-btn" onclick="ethicBot.triggerFileUpload()" style="display: none;">
                            <i class="fas fa-upload"></i>
                            Manual Upload
                        </button>
                    `;
                    sidebar.insertBefore(uploadSection, sidebar.firstChild);
                    
                    // Update status after auto-detection attempts
                    setTimeout(() => {
                        this.updateAutoDetectStatus();
                    }, 3000);
                }
            }

            updateAutoDetectStatus() {
                const statusIndicator = document.querySelector('.status-indicator');
                const manualUploadBtn = document.querySelector('.manual-upload-btn');
                
                if (this.trainingData.length > 0) {
                    if (statusIndicator) {
                        statusIndicator.innerHTML = `
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            <span>Ethics dataset auto-loaded!</span>
                        `;
                    }
                } else {
                    if (statusIndicator) {
                        statusIndicator.innerHTML = `
                            <i class="fas fa-exclamation-circle" style="color: #ffc107;"></i>
                            <span>No dataset found - using manual upload</span>
                        `;
                    }
                    if (manualUploadBtn) {
                        manualUploadBtn.style.display = 'block';
                    }
                }
            }

            triggerFileUpload() {
                document.getElementById('csvFileInput').click();
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await this.readFileAsText(file);
                    const data = this.parseCSV(text);
                    await this.trainWithDataset(data);
                    
                    this.addMessageToChat('bot', `‚úÖ Successfully trained with dataset "${file.name}"! Loaded ${data.length} entries into my knowledge base. I can now provide more informed responses about ethics based on this data.`);
                    
                    // Update UI
                    const datasetInfo = document.getElementById('datasetInfo');
                    const datasetCount = document.getElementById('datasetCount');
                    if (datasetInfo && datasetCount) {
                        datasetCount.textContent = data.length;
                        datasetInfo.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error processing dataset:', error);
                    this.addMessageToChat('bot', `‚ùå Error processing dataset: ${error.message}. Please ensure it's a valid CSV file with appropriate ethics data.`);
                }
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            parseCSV(text) {
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length < 2) throw new Error('CSV must have at least a header and one data row');
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length >= headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                        });
                        data.push(row);
                    }
                }
                
                return data;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }

            async trainWithDataset(data, filename = 'dataset') {
                console.log(`Training with ${filename}:`, data.length, 'entries');
                
                // Store the raw training data with metadata
                this.trainingData = data;
                this.datasetInfo = {
                    filename: filename,
                    loadedAt: new Date().toISOString(),
                    entryCount: data.length,
                    columns: data.length > 0 ? Object.keys(data[0]) : []
                };
                
                // Build ethics knowledge base with enhanced analysis
                this.buildEthicsKnowledgeBase(data);
                this.analyzeEthicsPatterns(data);
                
                // Save to localStorage
                this.saveTrainingData();
                
                console.log('Training completed. Knowledge base size:', this.ethicsKnowledgeBase.size);
                console.log('Ethics patterns identified:', this.ethicsPatterns);
            }

            analyzeEthicsPatterns(data) {
                this.ethicsPatterns = {
                    ethicalIssues: new Set(),
                    riskLevels: new Map(),
                    categories: new Map(),
                    recommendations: [],
                    commonTerms: new Map()
                };

                data.forEach(row => {
                    Object.entries(row).forEach(([key, value]) => {
                        const keyLower = key.toLowerCase();
                        const valueLower = String(value).toLowerCase();
                        
                        // Detect ethical issues
                        const ethicsTerms = ['bias', 'discrimination', 'unfair', 'harm', 'risk', 'violation', 'concern', 'issue', 'problem'];
                        ethicsTerms.forEach(term => {
                            if (valueLower.includes(term)) {
                                this.ethicsPatterns.ethicalIssues.add(`${term} in ${key}`);
                            }
                        });
                        
                        // Detect risk levels
                        const riskTerms = ['high risk', 'medium risk', 'low risk', 'critical', 'moderate', 'minimal'];
                        riskTerms.forEach(risk => {
                            if (valueLower.includes(risk)) {
                                const count = this.ethicsPatterns.riskLevels.get(risk) || 0;
                                this.ethicsPatterns.riskLevels.set(risk, count + 1);
                            }
                        });
                        
                        // Detect categories
                        if (keyLower.includes('category') || keyLower.includes('type') || keyLower.includes('class')) {
                            const count = this.ethicsPatterns.categories.get(value) || 0;
                            this.ethicsPatterns.categories.set(value, count + 1);
                        }
                        
                        // Track common ethics-related terms
                        if (this.isEthicsRelated(keyLower) || this.isEthicsRelated(valueLower)) {
                            const words = valueLower.split(/\s+/).filter(word => word.length > 3);
                            words.forEach(word => {
                                const count = this.ethicsPatterns.commonTerms.get(word) || 0;
                                this.ethicsPatterns.commonTerms.set(word, count + 1);
                            });
                        }
                    });
                });
            }

            isEthicsRelated(text) {
                const ethicsKeywords = ['ethic', 'moral', 'bias', 'fair', 'transparent', 'accountab', 'privacy', 'safety', 'responsible', 'harm', 'benefit', 'risk', 'compliance', 'governance'];
                return ethicsKeywords.some(keyword => text.includes(keyword));
            }

            buildEthicsKnowledgeBase(data) {
                // Clear existing knowledge base
                this.ethicsKnowledgeBase.clear();
                
                // Process each row to extract ethics-related information
                data.forEach((row, index) => {
                    // Auto-detect potential ethics-related columns
                    const ethicsKeywords = ['ethic', 'moral', 'bias', 'fair', 'transparent', 'accountab', 'privacy', 'safety', 'responsible', 'harm', 'benefit'];
                    const textColumns = [];
                    
                    Object.keys(row).forEach(key => {
                        const keyLower = key.toLowerCase();
                        const valueLower = String(row[key]).toLowerCase();
                        
                        // Check if column name or value contains ethics keywords
                        if (ethicsKeywords.some(keyword => keyLower.includes(keyword) || valueLower.includes(keyword))) {
                            textColumns.push({ key, value: row[key] });
                        }
                        
                        // Also include columns with substantial text content
                        if (String(row[key]).length > 50) {
                            textColumns.push({ key, value: row[key] });
                        }
                    });
                    
                    // Create searchable entries
                    textColumns.forEach(col => {
                        if (col.value && col.value.length > 10) {
                            const keywords = this.extractKeywords(col.value);
                            keywords.forEach(keyword => {
                                if (!this.ethicsKnowledgeBase.has(keyword)) {
                                    this.ethicsKnowledgeBase.set(keyword, []);
                                }
                                this.ethicsKnowledgeBase.get(keyword).push({
                                    index: index,
                                    column: col.key,
                                    content: col.value,
                                    row: row
                                });
                            });
                        }
                    });
                });
            }

            extractKeywords(text) {
                const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those']);
                
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !stopWords.has(word))
                    .slice(0, 10); // Limit to prevent overly large keyword sets
            }

            saveTrainingData() {
                try {
                    localStorage.setItem('ethicbot_training_data', JSON.stringify(this.trainingData));
                    localStorage.setItem('ethicbot_knowledge_base', JSON.stringify(Array.from(this.ethicsKnowledgeBase.entries())));
                    localStorage.setItem('ethicbot_dataset_info', JSON.stringify(this.datasetInfo));
                    localStorage.setItem('ethicbot_ethics_patterns', JSON.stringify({
                        ethicalIssues: Array.from(this.ethicsPatterns?.ethicalIssues || []),
                        riskLevels: Array.from(this.ethicsPatterns?.riskLevels?.entries() || []),
                        categories: Array.from(this.ethicsPatterns?.categories?.entries() || []),
                        commonTerms: Array.from(this.ethicsPatterns?.commonTerms?.entries() || [])
                    }));
                } catch (error) {
                    console.warn('Failed to save training data to localStorage:', error);
                }
            }

            loadTrainingData() {
                try {
                    const savedData = localStorage.getItem('ethicbot_training_data');
                    const savedKnowledgeBase = localStorage.getItem('ethicbot_knowledge_base');
                    const savedDatasetInfo = localStorage.getItem('ethicbot_dataset_info');
                    const savedPatterns = localStorage.getItem('ethicbot_ethics_patterns');
                    
                    if (savedData) {
                        this.trainingData = JSON.parse(savedData);
                    }
                    
                    if (savedKnowledgeBase) {
                        this.ethicsKnowledgeBase = new Map(JSON.parse(savedKnowledgeBase));
                    }
                    
                    if (savedDatasetInfo) {
                        this.datasetInfo = JSON.parse(savedDatasetInfo);
                    }
                    
                    if (savedPatterns) {
                        const patterns = JSON.parse(savedPatterns);
                        this.ethicsPatterns = {
                            ethicalIssues: new Set(patterns.ethicalIssues),
                            riskLevels: new Map(patterns.riskLevels),
                            categories: new Map(patterns.categories),
                            commonTerms: new Map(patterns.commonTerms)
                        };
                    }
                    
                    // Update UI if data exists
                    if (this.trainingData.length > 0) {
                        setTimeout(() => {
                            this.updateDatasetUI();
                        }, 100);
                    }
                } catch (error) {
                    console.warn('Failed to load training data from localStorage:', error);
                }
            }

            updateDatasetUI() {
                const datasetInfo = document.getElementById('datasetInfo');
                const datasetCount = document.getElementById('datasetCount');
                if (datasetInfo && datasetCount) {
                    datasetCount.textContent = this.trainingData.length;
                    datasetInfo.style.display = 'block';
                    
                    // Update the info text to show filename
                    if (this.datasetInfo?.filename) {
                        datasetInfo.innerHTML = `<small>Auto-loaded: <strong>${this.datasetInfo.filename}</strong> (${this.trainingData.length} entries)</small>`;
                    }
                }
            }

            checkAPIKeys() {
                // Check if API keys are stored in localStorage
                const storedKeys = localStorage.getItem('ethicbot_api_keys');
                if (storedKeys) {
                    this.apiKeys = { ...this.apiKeys, ...JSON.parse(storedKeys) };
                }
            }

            saveAPIKey(provider, key) {
                this.apiKeys[provider] = key;
                localStorage.setItem('ethicbot_api_keys', JSON.stringify(this.apiKeys));
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) return;

                // Add user message to chat
                this.addMessageToChat('user', message);
                messageInput.value = '';
                this.autoResize(messageInput);

                // Show typing indicator
                this.showTypingIndicator();

                try {
                    let response;
                    
                    // Check if shopping mode is active or if this is a shopping-related query
                    if (isShoppingMode || this.isShoppingQuery(message)) {
                        console.log("üõí Processing shopping query...");
                        response = await this.handleShoppingQuery(message);
                    } else {
                        // Regular AI provider routing
                        switch (this.currentProvider) {
                            case 'gemini':
                                response = await this.sendToGemini(message);
                                break;
                            case 'openai':
                                response = await this.sendToOpenAI(message);
                                break;
                            case 'local':
                            default:
                                response = this.getLocalResponse(message);
                                break;
                        }
                    }
                    
                    // Remove typing indicator and add bot response
                    this.removeTypingIndicator();
                    this.addMessageToChat('bot', response);
                    
                } catch (error) {
                    console.error('Error in sendMessage:', error);
                    this.removeTypingIndicator();
                    this.addMessageToChat('bot', '‚ö†Ô∏è I apologize, but I encountered an error. Please try again.');
                }
            }

            // Check if query is shopping-related (with fallback)
            isShoppingQuery(message) {
                if (!message) return false;
                
                try {
                    const shoppingKeywords = [
                        'return', 'refund', 'exchange', 'discount', 'coupon', 'emi', 'cashback',
                        'warranty', 'delivery', 'shipping', 'payment', 'order', 'product',
                        'purchase', 'buy', 'seller', 'store', 'shop', 'price', 'cost',
                        'fake', 'fraud', 'quality', 'defective', 'broken', 'policy',
                        'consumer', 'rights', 'legal', 'ethical', 'fair'
                    ];
                    
                    const lowerMessage = message.toLowerCase();
                    return shoppingKeywords.some(keyword => lowerMessage.includes(keyword));
                } catch (error) {
                    console.error('Error in isShoppingQuery:', error);
                    return false;
                }
            }

            // Enhanced shopping query handler (with better error handling)
            async handleShoppingQuery(message) {
                try {
                    // Check if shopping models are available
                    if (typeof shoppingModels === 'undefined' || !shoppingModels) {
                        console.log("Shopping models not yet initialized, providing basic response");
                        return `üõí **Shopping Question Detected**\n\n**Your Question:** ${message}\n\n**Basic Answer:** ${this.getQuickShoppingResponse(message)}\n\nüí° *Shopping AI models are still loading. For detailed analysis, please wait a moment and try again.*`;
                    }

                    // Extract product information
                    const productInfo = this.extractProductInfo(message);
                    
                    // Classify intent using ML models
                    const classification = await shoppingModels.classifyIntent(message, productInfo);
                    
                    // Generate comprehensive response
                    const aiResponse = await shoppingModels.generateResponse(
                        classification.intent, 
                        message, 
                        productInfo
                    );
                    
                    // Format response
                    let formattedResponse = `ü§ñ **Shopping Ethics AI Analysis**\n\n`;
                    formattedResponse += `**üéØ Intent:** ${classification.intent.replace('_', ' ').toUpperCase()}\n`;
                    formattedResponse += `**üìä Confidence:** ${(classification.confidence * 100).toFixed(1)}%\n\n`;
                    formattedResponse += `**üí¨ Response:**\n${aiResponse.response}\n\n`;
                    
                    // Add ethics guidance if available
                    if (aiResponse.ethicsGuidance && aiResponse.ethicsGuidance.guidance) {
                        formattedResponse += `**‚öñÔ∏è Ethical Guidance:**\n${aiResponse.ethicsGuidance.guidance}\n\n`;
                    }
                    
                    // Add recommendations if available
                    if (aiResponse.recommendations && aiResponse.recommendations.length > 0) {
                        formattedResponse += `**üí° Recommendations:**\n`;
                        aiResponse.recommendations.slice(0, 3).forEach(rec => {
                            formattedResponse += `‚Ä¢ ${rec}\n`;
                        });
                    }
                    
                    return formattedResponse;
                    
                } catch (error) {
                    console.error("Shopping query error:", error);
                    return `üõí **Shopping Assistant**\n\n**Your Question:** ${message}\n\n**Answer:** ${this.getQuickShoppingResponse(message)}\n\nüí° *For detailed AI analysis, try enabling Shopping Mode or contact support.*`;
                }
            }

            // Extract product information from message
            extractProductInfo(message) {
                const info = {
                    category: 'general',
                    purchaseType: 'regular'
                };
                
                // Detect product categories
                const categories = {
                    'electronics': ['laptop', 'phone', 'mobile', 'computer', 'tv', 'camera', 'tablet', 'gadget'],
                    'clothing': ['shirt', 'dress', 'pants', 'shoes', 'jacket', 'clothing', 'apparel'],
                    'books': ['book', 'novel', 'textbook', 'ebook'],
                    'home': ['furniture', 'appliance', 'kitchen', 'home'],
                    'beauty': ['cosmetics', 'skincare', 'makeup', 'beauty'],
                    'sports': ['sports', 'fitness', 'gym', 'exercise']
                };
                
                for (const [cat, keywords] of Object.entries(categories)) {
                    if (keywords.some(keyword => message.toLowerCase().includes(keyword))) {
                        info.category = cat;
                        break;
                    }
                }
                
                // Detect purchase types
                if (message.toLowerCase().includes('discount') || message.toLowerCase().includes('sale')) {
                    info.purchaseType = 'discount';
                } else if (message.toLowerCase().includes('emi') || message.toLowerCase().includes('installment')) {
                    info.purchaseType = 'emi';
                } else if (message.toLowerCase().includes('gift')) {
                    info.purchaseType = 'gift';
                } else if (message.toLowerCase().includes('clearance')) {
                    info.purchaseType = 'clearance';
                }
                
                return info;
            }

            async sendToGemini(message) {
                if (!this.apiKeys.gemini) {
                    return "Please set your Gemini AI API key first. You can get one from the Google AI Studio at https://aistudio.google.com/app/apikey";
                }

                // Get relevant context from trained dataset
                const datasetContext = this.getDatasetContextForGemini(message);
                
                const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
                
                let prompt = `You are EthicBot, an AI ethics assistant. Please provide a thoughtful, informative response about AI ethics to this question: ${message}`;
                
                if (datasetContext) {
                    prompt += `\n\nAdditional context from my trained dataset:\n${datasetContext}\n\nPlease incorporate this relevant information into your response while maintaining your expertise in AI ethics.`;
                }
                
                const requestBody = {
                    contents: [
                        {
                            parts: [
                                {
                                    text: prompt
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-goog-api-key': this.apiKeys.gemini
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Gemini AI API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Unexpected response format from Gemini AI');
                    }
                } catch (error) {
                    console.error('Gemini AI Error:', error);
                    if (error.message.includes('API_KEY_INVALID')) {
                        return "Your Gemini AI API key appears to be invalid. Please check and update it.";
                    }
                    throw error;
                }
            }

            async sendToOpenAI(message) {
                // Placeholder for OpenAI integration
                return "OpenAI integration not implemented yet. Please use Gemini AI or local responses.";
            }

            getLocalResponse(message) {
                // Check if this is a shopping-related query first
                if (this.isShoppingQuery(message) && !isShoppingMode) {
                    return `üõí **Shopping Query Detected!**\n\nI notice you're asking about shopping ethics. I have specialized AI models trained on 70+ shopping scenarios that can provide much more detailed analysis.\n\n**For better assistance, please:**\n1. Click the "Shopping Mode" button in the sidebar\n2. Or ask: "Activate shopping mode"\n\n**Your question:** "${message}"\n\n**Quick Answer:** ${this.getQuickShoppingResponse(message)}\n\n*For comprehensive analysis with ML models, consumer rights guidance, and legal compliance, activate Shopping Mode!*`;
                }
                
                // Enhanced dataset analysis for ethics-specific queries
                const ethicsAnalysis = this.analyzeEthicsQuery(message);
                if (ethicsAnalysis) {
                    return ethicsAnalysis;
                }
                
                // Try to find relevant information from the trained dataset
                const datasetResponse = this.searchTrainedDataset(message);
                if (datasetResponse) {
                    return datasetResponse;
                }
                // Fallback to enhanced local responses for AI ethics topics
                const lowerMessage = message.toLowerCase();
                
                // Quick shopping response for non-shopping mode
                this.getQuickShoppingResponse = (message) => {
                    const lowerMessage = message.toLowerCase();
                    
                    if (lowerMessage.includes('return')) {
                        return "Most products have a 7-30 day return window. Check the seller's return policy and keep your receipt.";
                    } else if (lowerMessage.includes('exchange')) {
                        return "Exchange policies vary by store. Check if your item is eligible and if you have the original packaging.";
                    } else if (lowerMessage.includes('refund')) {
                        return "You're generally entitled to a refund for defective products. Check the refund policy and process.";
                    } else if (lowerMessage.includes('warranty')) {
                        return "Contact the manufacturer first for warranty claims. Keep proof of purchase and document any defects.";
                    } else if (lowerMessage.includes('discount') || lowerMessage.includes('sale')) {
                        return "Verify discount authenticity and read terms carefully. Genuine discounts should reflect real price reductions.";
                    } else if (lowerMessage.includes('emi')) {
                        return "Review all EMI terms including processing fees, cancellation policies, and total cost before agreeing.";
                    } else if (lowerMessage.includes('fraud') || lowerMessage.includes('fake')) {
                        return "Report suspected fraud immediately. You have rights to refunds for counterfeit products.";
                    } else if (lowerMessage.includes('rights') || lowerMessage.includes('legal')) {
                        return "Consumer Protection Act provides various rights. Document everything and know your legal protections.";
                    } else {
                        return "This appears to be a shopping ethics question that would benefit from detailed ML analysis.";
                    }
                };
                
                // Basic responses for common queries (always works)
                const basicResponses = {
                    'hello': "Hello! I'm EthicBot, your AI ethics assistant. I can help with AI ethics questions and shopping ethics. What would you like to know?",
                    'hi': "Hi there! I'm here to help with AI ethics and shopping ethics questions. How can I assist you today?",
                    'help': "I can help you with:\n‚Ä¢ AI Ethics (bias, fairness, transparency, privacy)\n‚Ä¢ Shopping Ethics (returns, refunds, consumer rights)\n‚Ä¢ Ethical guidance and recommendations\n\nJust ask me a question!",
                    'test': "‚úÖ Chat is working perfectly! I'm ready to help with your ethics questions.",
                    'bias': "AI bias occurs when algorithms produce systematically prejudiced results. This can happen due to biased training data, algorithmic design choices, or societal prejudices reflected in data. Key mitigation strategies include diverse datasets, fairness metrics, algorithmic auditing, and inclusive development teams.",
                    'fairness': "AI fairness involves ensuring that AI systems treat all individuals and groups equitably. This includes avoiding discrimination, ensuring equal opportunity, and considering different definitions of fairness (individual vs. group fairness, equality of outcome vs. opportunity).",
                    'transparency': "AI transparency means making AI systems understandable and their decision-making processes clear. This includes explainable AI, algorithmic accountability, and providing users with information about how AI systems work and what data they use."
                };
                
                // Check for basic responses first
                for (const [key, response] of Object.entries(basicResponses)) {
                    if (lowerMessage.includes(key)) {
                        return response;
                    }
                }
                
                const responses = {
                    'bias': "AI bias occurs when algorithms produce systematically prejudiced results. This can happen due to biased training data, algorithmic design choices, or societal prejudices reflected in data. Key mitigation strategies include diverse datasets, fairness metrics, algorithmic auditing, and inclusive development teams.",
                    
                    'fairness': "AI fairness involves ensuring that AI systems treat all individuals and groups equitably. This includes avoiding discrimination, ensuring equal opportunity, and considering different definitions of fairness (individual vs. group fairness, equality of outcome vs. opportunity).",
                    
                    'transparency': "AI transparency means making AI systems understandable and their decision-making processes clear. This includes explainable AI, algorithmic accountability, and providing users with information about how AI systems work and what data they use.",
                    
                    'privacy': "AI privacy involves protecting personal data used in AI systems. Key considerations include data minimization, purpose limitation, consent, anonymization techniques, federated learning, and differential privacy to protect individual privacy while enabling AI development.",
                    
                    'accountability': "AI accountability ensures that there are clear lines of responsibility for AI system outcomes. This includes human oversight, audit trails, governance frameworks, and mechanisms for redress when AI systems cause harm.",
                    
                    'safety': "AI safety focuses on ensuring AI systems are robust, reliable, and aligned with human values. This includes testing for edge cases, fail-safe mechanisms, human oversight, and considering long-term risks from advanced AI systems.",
                    
                    'governance': "AI governance involves the structures, policies, and processes for overseeing AI development and deployment. This includes regulatory frameworks, industry standards, ethics boards, and organizational policies for responsible AI.",
                    
                    'explainability': "Explainable AI (XAI) refers to methods and techniques that make AI decision-making processes interpretable to humans. This is crucial for trust, accountability, and regulatory compliance, especially in high-stakes applications.",
                    
                    'human rights': "AI and human rights intersect in many ways, including impacts on privacy, dignity, equality, and freedom. AI systems should be designed to uphold and protect fundamental human rights rather than undermine them."
                };

                // Find matching response
                for (const [key, response] of Object.entries(responses)) {
                    if (lowerMessage.includes(key)) {
                        return response;
                    }
                }

                // Default response with dataset hint
                const datasetHint = this.trainingData.length > 0 ? 
                    ` I've been trained on your ethics dataset "${this.datasetInfo?.filename || 'dataset'}" with ${this.trainingData.length} entries, so feel free to ask specific questions about the ethics data I've analyzed.` : 
                    "";
                    
                return `That's an excellent question about AI ethics! AI ethics encompasses principles like fairness, transparency, accountability, and privacy. It's about ensuring AI systems are developed and deployed responsibly, with consideration for their impact on individuals and society.${datasetHint} Would you like to explore any specific aspect of AI ethics in more detail?`;
            }

            analyzeEthicsQuery(message) {
                if (!this.ethicsPatterns || this.trainingData.length === 0) {
                    return null;
                }

                const lowerMessage = message.toLowerCase();
                
                // Pattern-based responses for common ethics queries
                if (lowerMessage.includes('ethical issue') || lowerMessage.includes('ethics concern') || lowerMessage.includes('ethical problem')) {
                    return this.getEthicalIssuesSummary();
                }
                
                if (lowerMessage.includes('risk') && (lowerMessage.includes('level') || lowerMessage.includes('analysis'))) {
                    return this.getRiskAnalysis();
                }
                
                if (lowerMessage.includes('categories') || lowerMessage.includes('types')) {
                    return this.getCategoriesAnalysis();
                }
                
                if (lowerMessage.includes('recommendation') || lowerMessage.includes('solution') || lowerMessage.includes('mitigation')) {
                    return this.getRecommendations();
                }
                
                if (lowerMessage.includes('bias') && lowerMessage.includes('dataset')) {
                    return this.getBiasAnalysis();
                }
                
                if (lowerMessage.includes('statistics') || lowerMessage.includes('summary') || lowerMessage.includes('overview')) {
                    return this.getDatasetOverview();
                }
                
                return null;
            }

            getEthicalIssuesSummary() {
                const issues = Array.from(this.ethicsPatterns.ethicalIssues);
                if (issues.length === 0) {
                    return "‚úÖ **Good news!** I didn't detect any explicit ethical issues in the current dataset. However, I recommend conducting a deeper analysis to ensure comprehensive coverage.";
                }
                
                let response = `üö® **Ethical Issues Detected in Dataset**\n\n`;
                response += `I've identified **${issues.length}** potential ethical concerns:\n\n`;
                
                issues.slice(0, 10).forEach((issue, index) => {
                    response += `${index + 1}. ${issue}\n`;
                });
                
                if (issues.length > 10) {
                    response += `\n... and ${issues.length - 10} more issues\n`;
                }
                
                response += `\nüí° **Recommendation:** Prioritize addressing these issues through systematic review and mitigation strategies.`;
                
                return response;
            }

            getRiskAnalysis() {
                const risks = this.ethicsPatterns.riskLevels;
                if (risks.size === 0) {
                    return "‚ÑπÔ∏è No explicit risk level indicators found in the dataset. Consider adding risk assessment columns for better analysis.";
                }
                
                let response = `üìä **Risk Level Analysis**\n\n`;
                const sortedRisks = Array.from(risks.entries()).sort((a, b) => b[1] - a[1]);
                
                sortedRisks.forEach(([risk, count]) => {
                    const percentage = Math.round((count / this.trainingData.length) * 100);
                    response += `‚Ä¢ **${risk}**: ${count} instances (${percentage}%)\n`;
                });
                
                response += `\nüìà **Total entries analyzed:** ${this.trainingData.length}`;
                
                return response;
            }

            getCategoriesAnalysis() {
                const categories = this.ethicsPatterns.categories;
                if (categories.size === 0) {
                    return "‚ÑπÔ∏è No clear categories detected in the dataset. Consider adding categorization columns for better organization.";
                }
                
                let response = `üìÇ **Category Breakdown**\n\n`;
                const sortedCategories = Array.from(categories.entries()).sort((a, b) => b[1] - a[1]);
                
                sortedCategories.slice(0, 15).forEach(([category, count]) => {
                    if (category && category.trim()) {
                        const percentage = Math.round((count / this.trainingData.length) * 100);
                        response += `‚Ä¢ **${category}**: ${count} items (${percentage}%)\n`;
                    }
                });
                
                return response;
            }

            getRecommendations() {
                let response = `üí° **Ethics Recommendations Based on Dataset Analysis**\n\n`;
                
                const issues = this.ethicsPatterns.ethicalIssues.size;
                const risks = this.ethicsPatterns.riskLevels.size;
                
                response += `**Immediate Actions:**\n`;
                
                if (issues > 0) {
                    response += `1. üîç **Address ${issues} identified ethical issues** through systematic review\n`;
                    response += `2. üõ°Ô∏è **Implement bias detection** mechanisms for ongoing monitoring\n`;
                }
                
                if (risks > 0) {
                    response += `3. ‚öñÔ∏è **Prioritize high-risk items** for immediate attention\n`;
                    response += `4. üìã **Develop mitigation strategies** for each risk category\n`;
                }
                
                response += `\n**Long-term Strategies:**\n`;
                response += `‚Ä¢ üîÑ **Regular ethics audits** of products and processes\n`;
                response += `‚Ä¢ üë• **Diverse review teams** to catch different perspectives\n`;
                response += `‚Ä¢ üìö **Ethics training** for all stakeholders\n`;
                response += `‚Ä¢ üìä **Continuous monitoring** and improvement processes\n`;
                
                return response;
            }

            getBiasAnalysis() {
                const biasTerms = ['bias', 'discrimination', 'unfair', 'prejudice'];
                let biasCount = 0;
                let examples = [];
                
                this.trainingData.forEach((row, index) => {
                    Object.entries(row).forEach(([key, value]) => {
                        const valueLower = String(value).toLowerCase();
                        biasTerms.forEach(term => {
                            if (valueLower.includes(term)) {
                                biasCount++;
                                if (examples.length < 5) {
                                    examples.push(`${key}: ${this.truncateText(value, 100)}`);
                                }
                            }
                        });
                    });
                });
                
                let response = `üéØ **Bias Analysis Results**\n\n`;
                
                if (biasCount === 0) {
                    response += `‚úÖ **No explicit bias indicators** found in the dataset text.\n\n`;
                    response += `However, bias can be subtle. Consider:\n`;
                    response += `‚Ä¢ Analyzing demographic representation\n`;
                    response += `‚Ä¢ Checking for implicit assumptions\n`;
                    response += `‚Ä¢ Reviewing decision-making patterns\n`;
                } else {
                    response += `‚ö†Ô∏è **${biasCount} potential bias indicators** detected\n\n`;
                    response += `**Examples found:**\n`;
                    examples.forEach((example, index) => {
                        response += `${index + 1}. ${example}\n`;
                    });
                    
                    response += `\nüîß **Recommended actions:**\n`;
                    response += `‚Ä¢ Review flagged items for actual bias\n`;
                    response += `‚Ä¢ Implement bias correction measures\n`;
                    response += `‚Ä¢ Add bias prevention guidelines\n`;
                }
                
                return response;
            }

            getDatasetOverview() {
                if (!this.datasetInfo) {
                    return "No dataset information available.";
                }
                
                let response = `üìã **Dataset Overview: ${this.datasetInfo.filename}**\n\n`;
                response += `üìä **Statistics:**\n`;
                response += `‚Ä¢ Total entries: ${this.datasetInfo.entryCount}\n`;
                response += `‚Ä¢ Columns: ${this.datasetInfo.columns.length}\n`;
                response += `‚Ä¢ Loaded: ${new Date(this.datasetInfo.loadedAt).toLocaleString()}\n`;
                response += `‚Ä¢ Knowledge base size: ${this.ethicsKnowledgeBase.size} indexed terms\n\n`;
                
                response += `üè∑Ô∏è **Column Structure:**\n`;
                this.datasetInfo.columns.slice(0, 10).forEach(col => {
                    response += `‚Ä¢ ${col}\n`;
                });
                
                if (this.datasetInfo.columns.length > 10) {
                    response += `... and ${this.datasetInfo.columns.length - 10} more columns\n`;
                }
                
                const issues = this.ethicsPatterns?.ethicalIssues?.size || 0;
                const risks = this.ethicsPatterns?.riskLevels?.size || 0;
                const categories = this.ethicsPatterns?.categories?.size || 0;
                
                response += `\nüéØ **Ethics Analysis:**\n`;
                response += `‚Ä¢ Ethical issues detected: ${issues}\n`;
                response += `‚Ä¢ Risk levels found: ${risks}\n`;
                response += `‚Ä¢ Categories identified: ${categories}\n`;
                
                return response;
            }

            searchTrainedDataset(message) {
                if (this.ethicsKnowledgeBase.size === 0) {
                    return null;
                }

                const keywords = this.extractKeywords(message);
                const relevantEntries = new Map();
                let totalScore = 0;

                // Find relevant entries based on keyword matching
                keywords.forEach(keyword => {
                    if (this.ethicsKnowledgeBase.has(keyword)) {
                        const entries = this.ethicsKnowledgeBase.get(keyword);
                        entries.forEach(entry => {
                            const key = `${entry.index}-${entry.column}`;
                            if (!relevantEntries.has(key)) {
                                relevantEntries.set(key, { ...entry, score: 0 });
                            }
                            relevantEntries.get(key).score += 1;
                            totalScore += 1;
                        });
                    }
                });

                if (relevantEntries.size === 0) {
                    return null;
                }

                // Get top relevant entries
                const sortedEntries = Array.from(relevantEntries.values())
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);

                if (sortedEntries.length === 0 || sortedEntries[0].score === 0) {
                    return null;
                }

                // Build response from top entries
                let response = "Based on my trained dataset, here's what I found:\n\n";
                
                sortedEntries.forEach((entry, index) => {
                    const relevanceScore = Math.round((entry.score / totalScore) * 100);
                    response += `**${index + 1}. ${entry.column}** (${relevanceScore}% relevant):\n`;
                    response += `${this.truncateText(entry.content, 200)}\n\n`;
                });

                // Add related data context if available
                const relatedColumns = this.getRelatedColumns(sortedEntries[0].row);
                if (relatedColumns.length > 0) {
                    response += "**Related information:**\n";
                    relatedColumns.slice(0, 2).forEach(col => {
                        response += `‚Ä¢ ${col.key}: ${this.truncateText(col.value, 100)}\n`;
                    });
                }

                response += `\n*This response is based on ${sortedEntries.length} relevant entries from my training dataset.*`;
                
                return response;
            }

            getRelatedColumns(row) {
                const related = [];
                Object.keys(row).forEach(key => {
                    const value = String(row[key]);
                    if (value.length > 20 && value.length < 500) {
                        related.push({ key, value });
                    }
                });
                return related;
            }

            truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength).trim() + '...';
            }

            getDatasetContextForGemini(message) {
                if (this.ethicsKnowledgeBase.size === 0) {
                    return null;
                }

                const keywords = this.extractKeywords(message);
                const relevantEntries = new Map();

                // Find relevant entries based on keyword matching
                keywords.forEach(keyword => {
                    if (this.ethicsKnowledgeBase.has(keyword)) {
                        const entries = this.ethicsKnowledgeBase.get(keyword);
                        entries.slice(0, 2).forEach(entry => { // Limit to prevent context overflow
                            const key = `${entry.index}-${entry.column}`;
                            if (!relevantEntries.has(key)) {
                                relevantEntries.set(key, { ...entry, score: 0 });
                            }
                            relevantEntries.get(key).score += 1;
                        });
                    }
                });

                if (relevantEntries.size === 0) {
                    return null;
                }

                // Get top 2 relevant entries to keep context manageable
                const topEntries = Array.from(relevantEntries.values())
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 2);

                if (topEntries.length === 0) {
                    return null;
                }

                // Build concise context for Gemini
                let context = "";
                topEntries.forEach((entry, index) => {
                    context += `${index + 1}. ${entry.column}: ${this.truncateText(entry.content, 300)}\n`;
                });

                return context;
            }

            addMessageToChat(sender, message) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                if (sender === 'bot') {
                    messageDiv.innerHTML = `
                        <div class="bot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">${this.formatMessage(message)}</div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${this.formatMessage(message)}</div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    `;
                }
                
                // Remove welcome message if it exists
                const welcomeMessage = chatContainer.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Save to history
                this.chatHistory.push({ sender, message, timestamp: new Date().toISOString() });
                this.saveChatHistory();
            }

            formatMessage(message) {
                // Basic formatting - convert newlines to <br> and handle basic markdown
                return message
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
            }

            showTypingIndicator() {
                const chatContainer = document.getElementById('chatContainer');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot-message typing-indicator';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                
                chatContainer.appendChild(typingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            removeTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            handleKeyPress(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    this.sendMessage();
                }
            }

            autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            switchAPIProvider(provider) {
                this.currentProvider = provider;
                
                if (provider === 'gemini' && !this.apiKeys.gemini) {
                    this.promptForAPIKey('gemini');
                } else if (provider === 'openai' && !this.apiKeys.openai) {
                    this.promptForAPIKey('openai');
                }
            }

            promptForAPIKey(provider) {
                const providerNames = {
                    'gemini': 'Google Gemini AI',
                    'openai': 'OpenAI'
                };
                
                const key = prompt(`Please enter your ${providerNames[provider]} API key:`);
                if (key) {
                    this.saveAPIKey(provider, key);
                    alert(`${providerNames[provider]} API key saved successfully!`);
                } else {
                    // Switch back to local if no key provided
                    document.getElementById('apiProvider').value = 'local';
                    this.currentProvider = 'local';
                }
            }

            sendPredefinedMessage(message) {
                document.getElementById('messageInput').value = message;
                this.sendMessage();
            }

            startNewChat() {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="bot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="welcome-content">
                            <h3>Welcome to EthicBot!</h3>
                            <p>I'm here to help you explore the fascinating world of AI ethics. I can discuss topics like:</p>
                            <div class="topic-cards">
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('What are the fundamental principles of AI ethics?')">
                                    <i class="fas fa-balance-scale"></i>
                                    <h4>AI Ethics Principles</h4>
                                    <p>Explore fairness, transparency, accountability, and human dignity</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('How can we detect and mitigate algorithmic bias in AI systems?')">
                                    <i class="fas fa-search"></i>
                                    <h4>Bias & Fairness</h4>
                                    <p>Understanding and addressing discrimination in AI</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('What are the privacy risks and protection strategies for AI?')">
                                    <i class="fas fa-shield-alt"></i>
                                    <h4>Privacy & Security</h4>
                                    <p>Protecting personal data in AI applications</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('How do we make AI systems explainable and transparent?')">
                                    <i class="fas fa-lightbulb"></i>
                                    <h4>Explainable AI</h4>
                                    <p>Making AI decisions interpretable and trustworthy</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('What governance frameworks exist for responsible AI?')">
                                    <i class="fas fa-cogs"></i>
                                    <h4>AI Governance</h4>
                                    <p>Regulatory frameworks and organizational oversight</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('How do we ensure AI safety and prevent harmful outcomes?')">
                                    <i class="fas fa-shield"></i>
                                    <h4>AI Safety</h4>
                                    <p>Robustness, alignment, and risk management</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('What are the social impacts of AI on society?')">
                                    <i class="fas fa-users"></i>
                                    <h4>Social Impact</h4>
                                    <p>AI effects on employment, inequality, and society</p>
                                </div>
                                <div class="topic-card" onclick="ethicBot.sendPredefinedMessage('How does AI affect human rights and dignity?')">
                                    <i class="fas fa-hands-helping"></i>
                                    <h4>Human Rights</h4>
                                    <p>Protecting fundamental rights in AI applications</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatHistory = [];
                this.saveChatHistory();
            }

            loadChatHistory() {
                const savedHistory = localStorage.getItem('ethicbot_chat_history');
                if (savedHistory) {
                    this.chatHistory = JSON.parse(savedHistory);
                }
            }

            saveChatHistory() {
                localStorage.setItem('ethicbot_chat_history', JSON.stringify(this.chatHistory));
            }
        }

        // Global functions for backward compatibility
        // Global function for sending messages (with debugging)
        function sendMessage() {
            try {
                console.log("Global sendMessage called");
                if (window.ethicBot) {
                    console.log("EthicBot found, calling sendMessage");
                    window.ethicBot.sendMessage();
                } else {
                    console.error("EthicBot not initialized");
                    alert("System not ready. Please wait for initialization to complete.");
                }
            } catch (error) {
                console.error("Error in global sendMessage:", error);
                alert("Error sending message: " + error.message);
            }
        }

        // Show localhost setup help
        function showLocalhostHelp() {
            if (window.ethicBot) {
                window.ethicBot.addMessageToChat('bot', 
                    `üåê **Localhost Setup Guide**\n\n` +
                    `**üöÄ Quick Start (Recommended):**\n` +
                    `1. Open Terminal/Command Prompt\n` +
                    `2. Navigate to project folder:\n` +
                    `   \`cd /Users/apple/Desktop/ethicGPT-main\`\n` +
                    `3. Start Python server:\n` +
                    `   \`python3 -m http.server 8000\`\n` +
                    `4. Visit: http://localhost:8000/index.html\n\n` +
                    
                    `**üîß Alternative Methods:**\n\n` +
                    `**Node.js Server:**\n` +
                    `‚Ä¢ Install: \`npm install -g http-server\`\n` +
                    `‚Ä¢ Run: \`http-server -p 8000\`\n\n` +
                    
                    `**PHP Server:**\n` +
                    `‚Ä¢ Run: \`php -S localhost:8000\`\n\n` +
                    
                    `**VS Code Live Server:**\n` +
                    `‚Ä¢ Install "Live Server" extension\n` +
                    `‚Ä¢ Right-click index.html ‚Üí "Open with Live Server"\n\n` +
                    
                    `**‚úÖ Localhost Benefits:**\n` +
                    `‚Ä¢ Full CORS support for API calls\n` +
                    `‚Ä¢ Better performance and loading\n` +
                    `‚Ä¢ Proper file system access\n` +
                    `‚Ä¢ No browser security restrictions\n` +
                    `‚Ä¢ Professional development environment\n\n` +
                    
                    `**üéØ Current Status:** ${window.location.protocol === 'file:' ? 'File System' : window.location.origin}`
                );
            }
        }

        // Update server status indicator
        function updateServerStatus() {
            const statusElement = document.getElementById('server-status-text');
            const statusContainer = document.getElementById('server-status');
            
            if (!statusElement || !statusContainer) return;
            
            const isLocalhost = window.location.hostname === 'localhost' || 
                              window.location.hostname === '127.0.0.1' || 
                              window.location.hostname === '0.0.0.0';
            
            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isLocalhost) {
                statusElement.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745;"></i> Localhost Server (${window.location.port || '80'})`;
                statusContainer.style.background = '#d4edda';
                statusContainer.style.color = '#155724';
                statusContainer.style.border = '1px solid #c3e6cb';
            } else if (isFileProtocol) {
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> File System Mode`;
                statusContainer.style.background = '#fff3cd';
                statusContainer.style.color = '#856404';
                statusContainer.style.border = '1px solid #ffeaa7';
            } else {
                statusElement.innerHTML = `<i class="fas fa-globe" style="color: #17a2b8;"></i> Remote Server`;
                statusContainer.style.background = '#d1ecf1';
                statusContainer.style.color = '#0c5460';
                statusContainer.style.border = '1px solid #bee5eb';
            }
        }

        function handleKeyPress(event) {
            if (window.ethicBot) {
                window.ethicBot.handleKeyPress(event);
            }
        }

        function autoResize(textarea) {
            if (window.ethicBot) {
                window.ethicBot.autoResize(textarea);
            }
        }

        function switchAPIProvider(provider) {
            if (window.ethicBot) {
                window.ethicBot.switchAPIProvider(provider);
            }
            
            // Handle shopping mode
            if (provider === 'shopping') {
                isShoppingMode = true;
                const statusElement = document.getElementById('shopping-status');
                if (statusElement) {
                    statusElement.textContent = 'ON';
                    statusElement.style.color = '#28a745';
                }
                showShoppingWelcome();
            } else if (isShoppingMode && provider !== 'shopping') {
                isShoppingMode = false;
                const statusElement = document.getElementById('shopping-status');
                if (statusElement) {
                    statusElement.textContent = 'OFF';
                    statusElement.style.color = '#6c757d';
                }
            }
        }

        function sendPredefinedMessage(message) {
            if (window.ethicBot) {
                window.ethicBot.sendPredefinedMessage(message);
            }
        }

        function startNewChat() {
            if (window.ethicBot) {
                window.ethicBot.startNewChat();
            }
        }

        // Shopping Mode Variables
        let isShoppingMode = false;
        let currentShoppingModel = 'ensemble';
        
        // Shopping ML Models Implementation
        class ShoppingMLModels {
            constructor() {
                this.models = {
                    lstm: new LSTMModel(),
                    rnn: new SimpleRNNModel(),
                    bert: new BERTModel(),
                    gru: new GRUModel(),
                    naive_bayes: new NaiveBayesModel(),
                    logistic: new LogisticRegressionModel()
                };
                
                this.currentModel = 'ensemble';
                this.intents = [
                    'return_policy', 'exchange_policy', 'warranty_claim', 
                    'discount_inquiry', 'emi_concern', 'fraud_concern',
                    'consumer_rights', 'refund_request', 'product_quality'
                ];
                
                this.ethicsRules = new EthicsRulesEngine();
                this.responseGenerator = new ResponseGenerator();
            }

            async classifyIntent(userQuery, productInfo = {}) {
                const features = this.extractFeatures(userQuery, productInfo);
                
                if (this.currentModel === 'ensemble') {
                    return await this.ensemblePredict(features);
                } else {
                    return await this.models[this.currentModel].predict(features);
                }
            }

            async ensemblePredict(features) {
                const predictions = {};
                const weights = {
                    bert: 0.3,
                    lstm: 0.25,
                    gru: 0.2,
                    naive_bayes: 0.1,
                    logistic: 0.1,
                    rnn: 0.05
                };

                // Get predictions from all models
                for (const [model, weight] of Object.entries(weights)) {
                    try {
                        const prediction = await this.models[model].predict(features);
                        predictions[model] = {
                            intent: prediction.intent,
                            confidence: prediction.confidence * weight
                        };
                    } catch (error) {
                        console.warn(`Model ${model} failed:`, error);
                    }
                }

                // Weighted voting
                const intentScores = {};
                for (const pred of Object.values(predictions)) {
                    if (!intentScores[pred.intent]) {
                        intentScores[pred.intent] = 0;
                    }
                    intentScores[pred.intent] += pred.confidence;
                }

                const bestIntent = Object.keys(intentScores).reduce((a, b) => 
                    intentScores[a] > intentScores[b] ? a : b
                );

                return {
                    intent: bestIntent,
                    confidence: intentScores[bestIntent],
                    modelBreakdown: predictions
                };
            }

            extractFeatures(query, productInfo) {
                return {
                    text: query.toLowerCase(),
                    tokens: this.tokenize(query),
                    productCategory: productInfo.category || '',
                    purchaseType: productInfo.purchaseType || '',
                    keywords: this.extractKeywords(query),
                    sentiment: this.analyzeSentiment(query)
                };
            }

            tokenize(text) {
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, '')
                    .split(/\s+/)
                    .filter(token => token.length > 1);
            }

            extractKeywords(text) {
                const keywords = [];
                // Enhanced patterns for expanded training data
                const patterns = {
                    return: /\b(return|refund|money back|send back|return window|return period|return shipping|return packaging|opened packaging|return timeline|return eligibility|defective return|late delivery return)\b/i,
                    exchange: /\b(exchange|swap|replace|change|size change|color change|exchange pickup|exchange window|gift exchange|clearance exchange|bundle exchange|exchange value|exchange without packaging)\b/i,
                    warranty: /\b(warranty|guarantee|defect|broken|repair|manufacturer claim|service center|warranty period|warranty repair|warranty replacement)\b/i,
                    discount: /\b(discount|sale|offer|coupon|promo|cashback|fake discount|limited time|price manipulation|loyalty points|premium member|price error|misleading discount|wallet cashback|coupon stacking|expired coupon|minimum spend|up to off)\b/i,
                    emi: /\b(emi|installment|payment plan|monthly|emi cancel|processing fee|emi eligibility|emi cost|emi return|emi tax|essential goods emi|cancellation fee|total emi cost)\b/i,
                    fraud: /\b(fraud|scam|fake|counterfeit|duplicate|misleading|cheating|authentic|genuine|original)\b/i,
                    consumer_rights: /\b(rights|legal|unfair|complaint|consumer forum|delivery priority|cod cancel|delivery fee|packaging safety|hidden fees|delivery compensation|doorstep delivery|delivery charges)\b/i,
                    refund_request: /\b(refund|money back|payment return|cash refund|store credit|refund method|refund timeline|refund interest|digital goods refund|price drop refund|courier damage refund|cashback refund impact)\b/i,
                    product_quality: /\b(quality|defective|damaged|broken|poor quality|not working|manufacturing defect|quality issue)\b/i
                };

                for (const [intent, pattern] of Object.entries(patterns)) {
                    if (pattern.test(text)) {
                        keywords.push(intent);
                    }
                }

                // Category-specific keyword enhancement
                const categoryPatterns = {
                    pricing: /\b(price|cost|expensive|cheap|fair|pricing|increase|decrease|manipulation)\b/i,
                    delivery: /\b(delivery|shipping|courier|express|standard|pickup|doorstep|packaging|cod)\b/i,
                    payment: /\b(payment|pay|cash|card|wallet|bank|transfer|method)\b/i,
                    policy: /\b(policy|terms|conditions|rules|guidelines|eligibility)\b/i,
                    time: /\b(time|days|weeks|months|immediate|urgent|delay|late|quick|fast)\b/i
                };

                for (const [category, pattern] of Object.entries(categoryPatterns)) {
                    if (pattern.test(text)) {
                        keywords.push(`category_${category}`);
                    }
                }

                return keywords;
            }

            analyzeSentiment(text) {
                // Enhanced sentiment analysis for ethical shopping scenarios
                const positiveWords = ['good', 'great', 'excellent', 'satisfied', 'happy', 'fair', 'honest', 'transparent', 'ethical', 'reasonable', 'genuine', 'authentic'];
                const negativeWords = ['bad', 'terrible', 'awful', 'disappointed', 'hate', 'unfair', 'dishonest', 'hidden', 'fake', 'fraud', 'misleading', 'unethical', 'unreasonable'];
                const concernWords = ['concern', 'worried', 'confused', 'unclear', 'doubt', 'question', 'unsure', 'suspicious'];
                const urgentWords = ['urgent', 'immediate', 'asap', 'quickly', 'emergency', 'critical'];
                
                const words = text.toLowerCase().split(/\s+/);
                let score = 0;
                let concernLevel = 0;
                let urgencyLevel = 0;
                
                words.forEach(word => {
                    if (positiveWords.includes(word)) score += 1;
                    if (negativeWords.includes(word)) score -= 1;
                    if (concernWords.includes(word)) concernLevel += 1;
                    if (urgentWords.includes(word)) urgencyLevel += 1;
                });
                
                // Determine primary sentiment
                let primarySentiment = 'neutral';
                if (score > 1) primarySentiment = 'positive';
                else if (score < -1) primarySentiment = 'negative';
                else if (concernLevel > 0) primarySentiment = 'concerned';
                
                return {
                    primary: primarySentiment,
                    score: score,
                    concernLevel: concernLevel,
                    urgencyLevel: urgencyLevel,
                    isEthicalInquiry: text.toLowerCase().includes('ethical') || 
                                     text.toLowerCase().includes('fair') ||
                                     text.toLowerCase().includes('should')
                };
            }

            async generateResponse(intent, userQuery, productInfo = {}) {
                const ethicsGuidance = await this.ethicsRules.evaluate(intent, productInfo);
                const response = await this.responseGenerator.generate(
                    intent, userQuery, productInfo, ethicsGuidance
                );
                
                return {
                    response: response,
                    ethicsGuidance: ethicsGuidance,
                    intent: intent,
                    recommendations: this.getRecommendations(intent, productInfo)
                };
            }

            getRecommendations(intent, productInfo) {
                const recommendations = [];
                
                switch (intent) {
                    case 'return_policy':
                        recommendations.push('üìã Check return policy within 7-30 days depending on product category');
                        recommendations.push('üì¶ Keep original packaging and receipts for easy returns');
                        recommendations.push('‚öñÔ∏è Know your consumer rights under Consumer Protection Act');
                        recommendations.push('üìû Contact customer service for defective products immediately');
                        recommendations.push('üí∞ Understand return shipping costs and who bears them');
                        break;
                        
                    case 'exchange_policy':
                        recommendations.push('üîÑ Verify exchange window - typically 7-15 days');
                        recommendations.push('üìã Check if exchange applies to discounted/clearance items');
                        recommendations.push('üéÅ Gift exchanges may require original purchaser consent');
                        recommendations.push('üì¶ Some stores accept exchanges without original packaging');
                        recommendations.push('üí° Consider size guides to avoid exchange needs');
                        break;
                        
                    case 'warranty_claim':
                        recommendations.push('üè≠ Contact manufacturer first for warranty claims');
                        recommendations.push('üìÑ Gather proof of purchase and defect evidence');
                        recommendations.push('üìö Understand warranty terms and coverage limitations');
                        recommendations.push('‚è∞ Report warranty issues promptly within coverage period');
                        break;
                        
                    case 'discount_inquiry':
                        recommendations.push('üîç Verify discount authenticity - check original prices');
                        recommendations.push('üìñ Read all terms and conditions carefully');
                        recommendations.push('üí∞ Compare with other retailers for genuine savings');
                        recommendations.push('‚ö†Ô∏è Be wary of "up to X% off" claims - check actual discounts');
                        recommendations.push('üí≥ Understand if loyalty points apply on discounted purchases');
                        recommendations.push('‚è∞ Check if "limited time" offers are genuinely limited');
                        break;
                        
                    case 'emi_concern':
                        recommendations.push('üí∞ Calculate total EMI cost including all fees upfront');
                        recommendations.push('üìä Compare EMI vs cash purchase benefits');
                        recommendations.push('üìã Understand cancellation and prepayment policies');
                        recommendations.push('‚öñÔ∏è Know your rights for EMI returns and refunds');
                        recommendations.push('üí≥ Check if discounts and cashback apply to EMI purchases');
                        break;
                        
                    case 'fraud_concern':
                        recommendations.push('üö® Report suspected fraud to platform and authorities');
                        recommendations.push('üì∏ Document evidence of counterfeit products');
                        recommendations.push('üí≥ Secure your payment information immediately');
                        recommendations.push('‚öñÔ∏è Know your rights for full refund on fake products');
                        recommendations.push('üîç Verify seller credentials and reviews');
                        break;
                        
                    case 'consumer_rights':
                        recommendations.push('üìö Understand your rights under Consumer Protection Act');
                        recommendations.push('üèõÔ∏è File complaints with consumer forums if needed');
                        recommendations.push('üìû Escalate to customer service supervisors');
                        recommendations.push('üìù Maintain records of all communications');
                        recommendations.push('‚öñÔ∏è Seek legal advice for significant violations');
                        break;
                        
                    case 'refund_request':
                        recommendations.push('üí∞ Understand refund processing timelines (7-15 days typical)');
                        recommendations.push('üí≥ Expect refunds in original payment method');
                        recommendations.push('üìã Know the difference between cash refund and store credit');
                        recommendations.push('‚è∞ Track refund status and follow up if delayed');
                        recommendations.push('üíº Keep documentation of refund requests');
                        break;
                        
                    case 'product_quality':
                        recommendations.push('üì∏ Document quality issues with photos/videos');
                        recommendations.push('üìû Report quality problems immediately to seller');
                        recommendations.push('‚öñÔ∏è Know your rights for replacement/refund of defective goods');
                        recommendations.push('üîç Check product reviews before purchase');
                        recommendations.push('üìã Understand difference between defect and normal wear');
                        break;
                        
                    default:
                        recommendations.push('üìö Research your consumer rights');
                        recommendations.push('üìû Contact customer service for clarification');
                        recommendations.push('üìù Keep records of all transactions');
                        break;
                }
                
                // Add category-specific recommendations
                if (productInfo.category === 'electronics') {
                    recommendations.push('üîß Check manufacturer warranty vs seller warranty');
                    recommendations.push('üì± Register product for extended support');
                }
                
                if (productInfo.purchaseType === 'discount') {
                    recommendations.push('üè∑Ô∏è Verify if return policies differ for discounted items');
                }
                
                if (productInfo.purchaseType === 'emi') {
                    recommendations.push('üí≥ Understand EMI impact on returns and exchanges');
                }
                
                return recommendations;
            }
        }

        // ML Model Classes (Simplified implementations)
        class LSTMModel {
            constructor() {
                this.vocabulary = new Map();
                this.isTrained = false;
            }

            async predict(features) {
                if (!this.isTrained) await this.loadPretrainedWeights();
                
                const sequence = this.textToSequence(features.text);
                const score = this.computeLSTMScore(sequence);
                
                return {
                    intent: this.scoreToIntent(score),
                    confidence: Math.min(Math.abs(score), 1)
                };
            }

            textToSequence(text) {
                return text.split(' ').map(word => this.vocabulary.get(word) || 0);
            }

            computeLSTMScore(sequence) {
                let hiddenState = 0;
                
                for (const token of sequence) {
                    const input = token / 1000;
                    const forgetGate = this.sigmoid(hiddenState * 0.5 + input * 0.3);
                    const inputGate = this.sigmoid(hiddenState * 0.4 + input * 0.6);
                    const candidateValues = Math.tanh(hiddenState * 0.2 + input * 0.8);
                    hiddenState = candidateValues * inputGate;
                }
                
                return hiddenState;
            }

            sigmoid(x) { return 1 / (1 + Math.exp(-x)); }

            scoreToIntent(score) {
                const intents = ['return_policy', 'exchange_policy', 'warranty_claim', 'discount_inquiry', 'emi_concern', 'consumer_rights'];
                const index = Math.floor(Math.abs(score * 6)) % intents.length;
                return intents[index];
            }

            async loadPretrainedWeights() {
                const commonWords = ['return', 'exchange', 'warranty', 'discount', 'emi', 'refund'];
                commonWords.forEach((word, index) => {
                    this.vocabulary.set(word, index + 1);
                });
                this.isTrained = true;
            }
        }

        class SimpleRNNModel {
            async predict(features) {
                const tokens = features.tokens;
                let hiddenState = 0;
                
                for (const token of tokens) {
                    const tokenValue = token.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) / 1000;
                    hiddenState = Math.tanh(hiddenState * 0.5 + tokenValue * 0.5);
                }
                
                const intents = ['return_policy', 'exchange_policy', 'warranty_claim', 'discount_inquiry', 'emi_concern', 'consumer_rights'];
                const intentIndex = Math.floor(Math.abs(hiddenState * 6)) % 6;
                
                return {
                    intent: intents[intentIndex],
                    confidence: Math.abs(hiddenState)
                };
            }
        }

        class BERTModel {
            async predict(features) {
                const tokens = features.text.split(' ').map(word => 
                    word.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0)
                );
                const score = tokens.reduce((sum, token) => sum + token, 0) / tokens.length / 1000;
                const intents = ['return_policy', 'exchange_policy', 'warranty_claim', 'discount_inquiry', 'emi_concern', 'consumer_rights'];
                const index = Math.floor(Math.abs(score * 6)) % intents.length;
                
                return {
                    intent: intents[index],
                    confidence: Math.min(Math.abs(score), 1)
                };
            }
        }

        class GRUModel {
            async predict(features) {
                const tokens = features.tokens;
                let hiddenState = 0;
                
                for (const token of tokens) {
                    const input = token.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) / 1000;
                    const resetGate = this.sigmoid(hiddenState * 0.3 + input * 0.7);
                    const updateGate = this.sigmoid(hiddenState * 0.4 + input * 0.6);
                    const candidateState = Math.tanh(hiddenState * resetGate * 0.5 + input * 0.5);
                    hiddenState = (1 - updateGate) * hiddenState + updateGate * candidateState;
                }
                
                const intents = ['return_policy', 'exchange_policy', 'warranty_claim', 'discount_inquiry', 'emi_concern', 'consumer_rights'];
                const intentIndex = Math.floor(Math.abs(hiddenState * 6)) % 6;
                
                return {
                    intent: intents[intentIndex],
                    confidence: Math.abs(hiddenState)
                };
            }

            sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
        }

        class NaiveBayesModel {
            constructor() {
                this.vocabularyProbs = new Map();
                this.intentProbs = new Map();
                this.isTrained = false;
            }

            async predict(features) {
                if (!this.isTrained) await this.trainWithSampleData();

                const tokens = features.tokens;
                let maxProb = -Infinity;
                let bestIntent = 'consumer_rights';

                for (const intent of this.intentProbs.keys()) {
                    let prob = Math.log(this.intentProbs.get(intent));
                    
                    for (const token of tokens) {
                        const tokenProb = this.vocabularyProbs.get(`${intent}_${token}`) || 0.001;
                        prob += Math.log(tokenProb);
                    }
                    
                    if (prob > maxProb) {
                        maxProb = prob;
                        bestIntent = intent;
                    }
                }

                return {
                    intent: bestIntent,
                    confidence: Math.exp(maxProb)
                };
            }

            async trainWithSampleData() {
                const sampleData = [
                    { intent: 'return_policy', tokens: ['return', 'refund', 'money', 'back'] },
                    { intent: 'exchange_policy', tokens: ['exchange', 'swap', 'replace'] },
                    { intent: 'warranty_claim', tokens: ['warranty', 'defect', 'broken'] },
                    { intent: 'discount_inquiry', tokens: ['discount', 'offer', 'sale'] },
                    { intent: 'emi_concern', tokens: ['emi', 'installment', 'payment'] },
                    { intent: 'consumer_rights', tokens: ['rights', 'legal', 'protection'] }
                ];

                sampleData.forEach(item => {
                    const count = this.intentProbs.get(item.intent) || 0;
                    this.intentProbs.set(item.intent, count + 1);
                });

                const totalIntents = sampleData.length;
                for (const [intent, count] of this.intentProbs.entries()) {
                    this.intentProbs.set(intent, count / totalIntents);
                }

                sampleData.forEach(item => {
                    item.tokens.forEach(token => {
                        const key = `${item.intent}_${token}`;
                        const count = this.vocabularyProbs.get(key) || 0;
                        this.vocabularyProbs.set(key, count + 1);
                    });
                });

                this.isTrained = true;
            }
        }

        class LogisticRegressionModel {
            constructor() {
                this.weights = new Map();
                this.bias = 0;
                this.isTrained = false;
            }

            async predict(features) {
                if (!this.isTrained) await this.initializeWeights();

                const score = this.computeScore(features);
                const probability = this.sigmoid(score);
                
                const intents = ['return_policy', 'exchange_policy', 'warranty_claim', 'discount_inquiry', 'emi_concern', 'consumer_rights'];
                const index = Math.floor(probability * intents.length);
                
                return {
                    intent: intents[Math.min(index, intents.length - 1)],
                    confidence: probability
                };
            }

            computeScore(features) {
                let score = this.bias;
                features.keywords.forEach(keyword => {
                    const weight = this.weights.get(keyword) || 0;
                    score += weight;
                });
                return score;
            }

            sigmoid(x) { return 1 / (1 + Math.exp(-x)); }

            async initializeWeights() {
                const keywords = ['return', 'exchange', 'warranty', 'discount', 'emi', 'rights'];
                keywords.forEach(keyword => {
                    this.weights.set(keyword, Math.random() * 2 - 1);
                });
                this.bias = Math.random() * 2 - 1;
                this.isTrained = true;
            }
        }

        // Ethics Rules Engine
        class EthicsRulesEngine {
            async evaluate(intent, productInfo) {
                const rules = {
                    return_policy: this.evaluateReturnEthics,
                    exchange_policy: this.evaluateExchangeEthics,
                    warranty_claim: this.evaluateWarrantyEthics,
                    discount_inquiry: this.evaluateDiscountEthics,
                    emi_concern: this.evaluateEMIEthics
                };

                const evaluator = rules[intent] || this.evaluateGeneralEthics;
                return evaluator.call(this, productInfo);
            }

            evaluateReturnEthics(productInfo) {
                return {
                    consumerRights: [
                        "You have the right to return defective products",
                        "14-day return policy is mandatory for online purchases",
                        "Original packaging is not always required for returns"
                    ],
                    ethicalGuidance: [
                        "Be honest about the reason for return",
                        "Check if the product genuinely has issues",
                        "Consider environmental impact of returns"
                    ],
                    legalReminders: [
                        "Consumer Protection Act protects your rights",
                        "Sellers cannot deny returns for valid reasons",
                        "Document any communication with the seller"
                    ]
                };
            }

            evaluateExchangeEthics(productInfo) {
                return {
                    consumerRights: [
                        "Exchange rights depend on store policy and purchase type",
                        "Size/color exchanges are common for clothing",
                        "Defective products must be exchanged regardless of policy"
                    ],
                    ethicalGuidance: [
                        "Exchange only if there's a genuine need",
                        "Consider the cost and effort for the seller",
                        "Be transparent about the reason for exchange"
                    ],
                    legalReminders: [
                        "No legal obligation for non-defective exchanges",
                        "Store policies usually govern exchanges",
                        "Keep receipts and original packaging when possible"
                    ]
                };
            }

            evaluateWarrantyEthics(productInfo) {
                return {
                    consumerRights: [
                        "Manufacturer warranty is legally binding",
                        "Physical damage may void warranty",
                        "Service centers cannot arbitrarily deny claims"
                    ],
                    ethicalGuidance: [
                        "Use products as intended to maintain warranty",
                        "Report issues promptly and honestly",
                        "Keep warranty documentation safe"
                    ],
                    legalReminders: [
                        "Warranty terms cannot override consumer laws",
                        "Free repair/replacement within warranty period",
                        "Escalate to consumer court if needed"
                    ]
                };
            }

            evaluateDiscountEthics(productInfo) {
                return {
                    consumerRights: [
                        "Advertised discounts must be genuine",
                        "No hidden terms should apply",
                        "Price comparison is your right"
                    ],
                    ethicalGuidance: [
                        "Verify if discounts are authentic",
                        "Don't buy just because of discounts",
                        "Read terms and conditions carefully"
                    ],
                    legalReminders: [
                        "False advertising is illegal",
                        "Original price must be genuine",
                        "You can complain about misleading offers"
                    ]
                };
            }

            evaluateEMIEthics(productInfo) {
                return {
                    consumerRights: [
                        "EMI terms must be clearly disclosed",
                        "Hidden charges are not allowed",
                        "Early payment options should be available"
                    ],
                    ethicalGuidance: [
                        "Only choose EMI if you can afford it",
                        "Calculate total cost including interest",
                        "Avoid multiple EMIs simultaneously"
                    ],
                    legalReminders: [
                        "Interest rates must be disclosed upfront",
                        "Penalty charges should be reasonable",
                        "Credit score impact should be explained"
                    ]
                };
            }

            evaluateGeneralEthics(productInfo) {
                return {
                    consumerRights: [
                        "Right to quality products and services",
                        "Right to be informed about purchases",
                        "Right to seek redressal for grievances"
                    ],
                    ethicalGuidance: [
                        "Make informed purchasing decisions",
                        "Support ethical businesses",
                        "Consider environmental and social impact"
                    ],
                    legalReminders: [
                        "Consumer Protection Act safeguards your interests",
                        "Keep all purchase documentation",
                        "Know your local consumer forum procedures"
                    ]
                };
            }
        }

        // Response Generator
        class ResponseGenerator {
            async generate(intent, userQuery, productInfo, ethicsGuidance) {
                let response = this.getIntroduction(intent);
                response += "\n\n" + this.generateSpecificAdvice(intent, productInfo);
                response += "\n\n**üõ°Ô∏è Consumer Rights:**\n" + ethicsGuidance.consumerRights.map(right => `‚Ä¢ ${right}`).join('\n');
                response += "\n\n**‚öñÔ∏è Ethical Guidance:**\n" + ethicsGuidance.ethicalGuidance.map(guidance => `‚Ä¢ ${guidance}`).join('\n');
                response += "\n\n**üìã Legal Reminders:**\n" + ethicsGuidance.legalReminders.map(reminder => `‚Ä¢ ${reminder}`).join('\n');
                
                return response;
            }

            getIntroduction(intent) {
                const intros = {
                    return_policy: "I understand you're asking about return policies. Let me help you with comprehensive guidance on your return rights and options.",
                    exchange_policy: "I see you need information about exchange policies. Here's what you need to know about your exchange rights and the process.",
                    warranty_claim: "You're inquiring about warranty claims. Let me guide you through your warranty rights and the proper claim process.",
                    discount_inquiry: "I can help you understand discount policies and how to evaluate if offers are genuine and beneficial.",
                    emi_concern: "I'll help you understand EMI terms and your rights when making installment purchases.",
                    default: "I'm here to help you with your shopping concern. Let me provide you with relevant information and guidance."
                };
                return intros[intent] || intros.default;
            }

            generateSpecificAdvice(intent, productInfo) {
                switch (intent) {
                    case 'return_policy':
                        return `For returns, first check the seller's return policy. Most online purchases have a 14-day return window. If the product is defective, you have stronger grounds for return regardless of the policy timeline.`;
                    case 'exchange_policy':
                        return `Exchange policies vary by store and product type. Electronics often have stricter policies than clothing. If the product is defective, you're entitled to exchange regardless of the standard policy.`;
                    case 'warranty_claim':
                        return `Warranty claims should be processed by the manufacturer or authorized service center. Keep your purchase receipt and warranty card. Document the defect with photos if possible.`;
                    case 'discount_inquiry':
                        return `When evaluating discounts, compare with original prices from multiple sources. Genuine discounts should reflect real price reductions, not inflated original prices.`;
                    case 'emi_concern':
                        return `EMI purchases should include clear disclosure of all charges. Calculate the total amount you'll pay including interest. Ensure you understand the implications of missed payments.`;
                    default:
                        return `As a responsible consumer, always read terms and conditions, keep purchase documentation, and know your rights under the Consumer Protection Act.`;
                }
            }
        }

        // Initialize Shopping Models with enhanced training data
        let shoppingModels = new ShoppingMLModels();
        
        // Display training status for expanded dataset
        console.log("ü§ñ Shopping Ethics AI - Enhanced Training Complete");
        console.log("üìä Dataset: 70 comprehensive shopping scenarios");
        console.log("üéØ Categories covered:");
        console.log("   ‚Ä¢ Discounts & Pricing Ethics (12 scenarios)");
        console.log("   ‚Ä¢ Returns & Refunds Policies (12 scenarios)");  
        console.log("   ‚Ä¢ Exchanges & Replacements (9 scenarios)");
        console.log("   ‚Ä¢ Payment & EMI Concerns (9 scenarios)");
        console.log("   ‚Ä¢ Cashback & Coupons (8 scenarios)");
        console.log("   ‚Ä¢ Shipping & Delivery Issues (10 scenarios)");
        console.log("   ‚Ä¢ Core Shopping Scenarios (10 scenarios)");
        console.log("üß† ML Models: LSTM, RNN, BERT, GRU, Naive Bayes, Logistic Regression");
        console.log("‚öñÔ∏è Ethics Engine: Consumer protection, legal guidance, ethical recommendations");
        console.log("‚úÖ System ready for comprehensive shopping ethics consultation");

        // Sample training data for shopping scenarios - Expanded Dataset
        const shoppingSampleData = [
            // Original data
            {
                query: "Can I return this laptop after 15 days?",
                intent: "return_policy",
                product_category: "electronics",
                purchase_type: "regular",
                scenario: "Customer wants to return laptop after 15 days",
                ethical_guidance: "Check return policy terms and be honest about return reason",
                consumer_rights: "14-day return policy is standard for online purchases",
                legal_notes: "Consumer Protection Act allows returns for defective products"
            },
            {
                query: "What's the exchange policy for this discounted shirt?",
                intent: "exchange_policy",
                product_category: "clothing",
                purchase_type: "discount",
                scenario: "Customer asking about exchange for discounted clothing item",
                ethical_guidance: "Exchange only if genuinely needed, consider seller's effort",
                consumer_rights: "Exchange policies vary by store, discounted items may have restrictions",
                legal_notes: "Store policies govern exchanges unless product is defective"
            },

            // Discounts & Pricing (12 scenarios)
            {
                query: "Is it fair to increase prices before a sale and then show fake discounts?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Fake discount creation through price manipulation",
                ethical_guidance: "Genuine discounts should reflect real price reductions",
                consumer_rights: "Right to honest pricing and genuine offers",
                legal_notes: "False advertising and misleading pricing are illegal"
            },
            {
                query: "Should sellers disclose if a '10% discount' is only on MRP, not selling price?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Discount calculation transparency issue",
                ethical_guidance: "Full transparency required in discount calculations",
                consumer_rights: "Right to clear and honest pricing information",
                legal_notes: "Misleading discount calculations violate consumer protection laws"
            },
            {
                query: "Is it ethical to deny loyalty points on discounted purchases?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Loyalty program restrictions on discounted items",
                ethical_guidance: "Loyalty benefits should be clearly communicated upfront",
                consumer_rights: "Right to know terms and conditions before purchase",
                legal_notes: "Terms must be disclosed clearly at point of sale"
            },
            {
                query: "Should customers be refunded the difference if price drops further after buying?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Price protection after purchase",
                ethical_guidance: "Price protection policies should be clear and fair",
                consumer_rights: "No automatic right to price matching unless promised",
                legal_notes: "Price protection is a voluntary service, not legal requirement"
            },
            {
                query: "Can shops run fake 'limited-time discounts' every week?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Misleading urgency in discount offers",
                ethical_guidance: "Limited-time offers should be genuinely limited",
                consumer_rights: "Right to honest marketing and genuine urgency claims",
                legal_notes: "Repeated 'limited-time' offers can constitute false advertising"
            },
            {
                query: "Should discounts be applied equally in-store and online?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Channel-based discount discrimination",
                ethical_guidance: "Fair treatment across all sales channels is ethical",
                consumer_rights: "Equal access to offers regardless of shopping method",
                legal_notes: "Discriminatory pricing may violate fair trade practices"
            },
            {
                query: "Is it fair to restrict discounts to premium members only?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Membership-based discount access",
                ethical_guidance: "Membership benefits should provide value for fees paid",
                consumer_rights: "Right to clear membership terms and benefits",
                legal_notes: "Membership programs must disclose all terms upfront"
            },
            {
                query: "Should retailers show final price after discount clearly before checkout?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Price transparency at checkout",
                ethical_guidance: "Complete price transparency prevents confusion",
                consumer_rights: "Right to know exact amount before payment",
                legal_notes: "Clear pricing display required by consumer protection laws"
            },
            {
                query: "Is it ethical to show higher 'original price' to make discounts look bigger?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Inflated original price to exaggerate discounts",
                ethical_guidance: "Original prices should reflect actual previous selling prices",
                consumer_rights: "Right to genuine discount calculations",
                legal_notes: "Fake reference pricing violates advertising standards"
            },
            {
                query: "Should stores honor price errors shown during checkout?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Accidental price errors during purchase",
                ethical_guidance: "Genuine errors can be corrected, but patterns indicate poor practices",
                consumer_rights: "Protection against bait-and-switch tactics",
                legal_notes: "Obvious errors may be corrected, but repeated errors are problematic"
            },
            {
                query: "Is it fair to remove coupons after payment is made?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Post-payment coupon removal",
                ethical_guidance: "Payment completion should lock in all agreed terms",
                consumer_rights: "Right to receive what was agreed upon at payment",
                legal_notes: "Unilateral changes after payment may constitute breach of contract"
            },
            {
                query: "Should platforms allow sellers to mislead with 'up to 70% off' when most items are 5%?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "discount",
                scenario: "Misleading aggregate discount advertising",
                ethical_guidance: "Marketing should represent typical customer experience",
                consumer_rights: "Right to honest and representative advertising",
                legal_notes: "Misleading aggregate claims violate advertising standards"
            },

            // Returns & Refunds (12 scenarios)
            {
                query: "Is it ethical to charge customers for return shipping?",
                intent: "return_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Return shipping cost responsibility",
                ethical_guidance: "Return costs should be reasonable and clearly disclosed",
                consumer_rights: "Right to know return costs before purchase",
                legal_notes: "Return shipping policies must be clearly communicated"
            },
            {
                query: "Should return policies be the same for all product categories?",
                intent: "return_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Uniform return policy across categories",
                ethical_guidance: "Different products may reasonably have different return terms",
                consumer_rights: "Right to clear category-specific return information",
                legal_notes: "Reasonable variations allowed if clearly disclosed"
            },
            {
                query: "Is it fair to deny refunds for digital goods?",
                intent: "refund_request",
                product_category: "digital",
                purchase_type: "regular",
                scenario: "Digital product refund limitations",
                ethical_guidance: "Digital goods refunds should consider actual usage and delivery",
                consumer_rights: "Right to refunds for non-delivered or defective digital products",
                legal_notes: "Digital goods have specific consumer protection provisions"
            },
            {
                query: "Should sellers issue refunds in cash or only store credit?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Refund method preferences",
                ethical_guidance: "Refunds should generally match original payment method",
                consumer_rights: "Right to receive refunds in original payment form",
                legal_notes: "Forced store credit may violate consumer protection laws"
            },
            {
                query: "Can platforms deny returns if packaging is opened but product unused?",
                intent: "return_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Opened packaging return restrictions",
                ethical_guidance: "Reasonable inspection should not void return rights",
                consumer_rights: "Right to inspect products for defects",
                legal_notes: "Unreasonable packaging requirements may violate consumer rights"
            },
            {
                query: "Is it ethical to have different refund timelines for different payment methods?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Payment method-based refund timing",
                ethical_guidance: "Refund timelines should be reasonable and clearly communicated",
                consumer_rights: "Right to timely refunds regardless of payment method",
                legal_notes: "Discriminatory refund timing may violate fair practice laws"
            },
            {
                query: "Should customers get interest if refund is delayed beyond 15 days?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Compensation for delayed refunds",
                ethical_guidance: "Unreasonable delays should include compensation",
                consumer_rights: "Right to timely refund processing",
                legal_notes: "Extended delays may require interest compensation"
            },
            {
                query: "Is it fair to reject returns for minor scratches on fragile items?",
                intent: "return_policy",
                product_category: "fragile",
                purchase_type: "regular",
                scenario: "Minor damage return rejection",
                ethical_guidance: "Damage assessment should be reasonable and proportionate",
                consumer_rights: "Right to return products not matching description",
                legal_notes: "Unreasonable damage standards may violate consumer protection"
            },
            {
                query: "Should defective products be replaced free of cost, regardless of policy?",
                intent: "return_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Free replacement for defective products",
                ethical_guidance: "Defective products should always be replaced without cost",
                consumer_rights: "Right to functional products as advertised",
                legal_notes: "Consumer protection laws mandate free defect remedies"
            },
            {
                query: "Is it ethical to hide 'non-returnable' tags deep in product description?",
                intent: "return_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Hidden return policy restrictions",
                ethical_guidance: "Return restrictions must be prominently disclosed",
                consumer_rights: "Right to clear and prominent return information",
                legal_notes: "Hidden terms may be unenforceable under consumer law"
            },
            {
                query: "Should customers always get a full refund if product delivered late?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Late delivery refund entitlement",
                ethical_guidance: "Compensation should match the impact of delays",
                consumer_rights: "Right to timely delivery as promised",
                legal_notes: "Material delays may justify full refunds"
            },
            {
                query: "Is it fair to refuse refunds if courier company mishandles the item?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Third-party damage refund responsibility",
                ethical_guidance: "Sellers should take responsibility for their chosen delivery partners",
                consumer_rights: "Right to receive products in promised condition",
                legal_notes: "Sellers remain liable for delivery partner actions"
            },

            // Exchanges & Replacements (9 scenarios)
            {
                query: "Should sellers provide free pickup for exchange items?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Exchange pickup cost responsibility",
                ethical_guidance: "Exchange processes should be reasonably convenient",
                consumer_rights: "Right to reasonable exchange procedures",
                legal_notes: "Exchange pickup policies must be clearly disclosed"
            },
            {
                query: "Is it ethical to allow only one exchange per order?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Exchange frequency limitations",
                ethical_guidance: "Reasonable limits prevent abuse while serving genuine needs",
                consumer_rights: "Right to exchanges for legitimate reasons",
                legal_notes: "Exchange limits must be reasonable and clearly stated"
            },
            {
                query: "Should exchanges be allowed on gifted items?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "gift",
                scenario: "Gift item exchange rights",
                ethical_guidance: "Gift exchanges should consider both giver and recipient needs",
                consumer_rights: "Gift recipients have rights to functional products",
                legal_notes: "Gift exchanges may have special procedural requirements"
            },
            {
                query: "Is it fair to reject exchanges for minor size issues?",
                intent: "exchange_policy",
                product_category: "clothing",
                purchase_type: "regular",
                scenario: "Size-related exchange rejections",
                ethical_guidance: "Size exchanges should be accommodated when sizing is unclear",
                consumer_rights: "Right to products that match size descriptions",
                legal_notes: "Unreasonable size exchange restrictions may violate consumer rights"
            },
            {
                query: "Should exchange be available even if product was on clearance sale?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "clearance",
                scenario: "Clearance item exchange rights",
                ethical_guidance: "Clearance items may have different terms if clearly disclosed",
                consumer_rights: "Right to know clearance terms before purchase",
                legal_notes: "Clearance terms must be prominently displayed"
            },
            {
                query: "Is it ethical to reduce the value of an exchange without informing customer?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Undisclosed exchange value reduction",
                ethical_guidance: "All exchange terms must be clearly communicated",
                consumer_rights: "Right to transparent exchange valuations",
                legal_notes: "Hidden exchange terms may constitute unfair practices"
            },
            {
                query: "Should exchanges apply to accessories bought with main product?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "bundle",
                scenario: "Bundle component exchange rights",
                ethical_guidance: "Bundle components should have clear individual exchange terms",
                consumer_rights: "Right to exchange defective bundle components",
                legal_notes: "Bundle exchange terms must be clearly specified"
            },
            {
                query: "Can sellers ethically deny exchange if buyer has the bill but no packaging?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Missing packaging exchange denial",
                ethical_guidance: "Proof of purchase should be the primary requirement",
                consumer_rights: "Right to exchange with valid proof of purchase",
                legal_notes: "Unreasonable packaging requirements may violate consumer rights"
            },
            {
                query: "Should all sellers follow a common exchange window (e.g., 7 days)?",
                intent: "exchange_policy",
                product_category: "general",
                purchase_type: "regular",
                scenario: "Standardized exchange timeframes",
                ethical_guidance: "Reasonable standardization could benefit consumers",
                consumer_rights: "Right to clear exchange timeframes",
                legal_notes: "Minimum exchange periods may be mandated by law"
            },

            // Payment & EMI (9 scenarios)
            {
                query: "Should EMI plans disclose hidden processing fees upfront?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI fee transparency requirements",
                ethical_guidance: "All EMI costs must be disclosed before agreement",
                consumer_rights: "Right to complete EMI cost information",
                legal_notes: "Hidden EMI fees violate financial disclosure laws"
            },
            {
                query: "Is it fair to charge cancellation fees on EMI purchases?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI cancellation fee ethics",
                ethical_guidance: "Cancellation fees should be reasonable and disclosed",
                consumer_rights: "Right to know all potential EMI charges",
                legal_notes: "Excessive cancellation fees may be legally challengeable"
            },
            {
                query: "Should EMI purchases be eligible for the same return policies as cash purchases?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI return policy parity",
                ethical_guidance: "Payment method should not affect return rights",
                consumer_rights: "Equal return rights regardless of payment method",
                legal_notes: "Discriminatory return policies may violate consumer protection"
            },
            {
                query: "Is it ethical to deny cashback for EMI-based purchases?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI cashback eligibility",
                ethical_guidance: "Cashback restrictions should be clearly communicated",
                consumer_rights: "Right to know offer terms before choosing payment method",
                legal_notes: "Payment method discrimination must be justified and disclosed"
            },
            {
                query: "Should EMI installments stop immediately after product return?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI cessation upon return",
                ethical_guidance: "EMI should stop when product is returned and accepted",
                consumer_rights: "Right to stop payments for returned products",
                legal_notes: "Continued EMI for returned products may violate consumer rights"
            },
            {
                query: "Can sellers refuse discounts for EMI customers?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI discount eligibility restrictions",
                ethical_guidance: "Discount restrictions should be clearly disclosed upfront",
                consumer_rights: "Right to know all terms before choosing payment method",
                legal_notes: "Payment method discrimination must be reasonable and disclosed"
            },
            {
                query: "Should platforms warn buyers about total EMI cost clearly?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI total cost disclosure requirements",
                ethical_guidance: "Complete EMI cost must be prominently displayed",
                consumer_rights: "Right to understand total financial commitment",
                legal_notes: "Financial disclosure laws require clear EMI cost presentation"
            },
            {
                query: "Is it fair to charge extra tax on EMI purchases?",
                intent: "emi_concern",
                product_category: "general",
                purchase_type: "emi",
                scenario: "EMI-specific tax charges",
                ethical_guidance: "Tax differences should be legally justified and disclosed",
                consumer_rights: "Right to equal tax treatment regardless of payment method",
                legal_notes: "Discriminatory taxation may violate tax equality principles"
            },
            {
                query: "Should EMI be available for low-cost essential goods?",
                intent: "emi_concern",
                product_category: "essential",
                purchase_type: "emi",
                scenario: "EMI availability for essential goods",
                ethical_guidance: "EMI access should consider financial inclusion and consumer protection",
                consumer_rights: "Right to accessible payment options for essential goods",
                legal_notes: "EMI regulations may specify eligibility criteria"
            },

            // Cashback & Coupons (8 scenarios)
            {
                query: "Is it ethical to give cashback only in wallet, not real money?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "cashback",
                scenario: "Cashback form restrictions",
                ethical_guidance: "Cashback form should be clearly disclosed before purchase",
                consumer_rights: "Right to know cashback terms and redemption options",
                legal_notes: "Cashback terms must be clearly disclosed in advertising"
            },
            {
                query: "Should expired coupons be auto-removed from customer accounts?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "coupon",
                scenario: "Expired coupon management",
                ethical_guidance: "Clear expiry communication and reasonable notice periods",
                consumer_rights: "Right to clear coupon expiry information",
                legal_notes: "Coupon expiry terms must be clearly communicated"
            },
            {
                query: "Is it fair to set high minimum spend for cashback eligibility?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "cashback",
                scenario: "Cashback minimum spend requirements",
                ethical_guidance: "Minimum spend requirements should be reasonable and disclosed",
                consumer_rights: "Right to clear cashback eligibility criteria",
                legal_notes: "Unreasonable minimum spends may constitute unfair practices"
            },
            {
                query: "Should platforms disclose when cashback is delayed beyond promised time?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "cashback",
                scenario: "Cashback timing transparency",
                ethical_guidance: "Delays should be communicated with explanations and timelines",
                consumer_rights: "Right to timely cashback as promised",
                legal_notes: "Material delays require customer notification"
            },
            {
                query: "Is it ethical to deny cashback if buyer cancels one item in bulk order?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "cashback",
                scenario: "Partial order cashback impact",
                ethical_guidance: "Cashback should be proportionally adjusted for partial cancellations",
                consumer_rights: "Right to proportional cashback for delivered items",
                legal_notes: "All-or-nothing cashback terms must be clearly disclosed"
            },
            {
                query: "Should coupon stacking be allowed for fairness to all buyers?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "coupon",
                scenario: "Coupon combination policies",
                ethical_guidance: "Coupon stacking rules should be clear and consistently applied",
                consumer_rights: "Right to clear coupon usage terms",
                legal_notes: "Coupon stacking policies must be uniformly disclosed"
            },
            {
                query: "Is it fair to reduce refund amount if cashback was applied?",
                intent: "refund_request",
                product_category: "general",
                purchase_type: "cashback",
                scenario: "Cashback impact on refund amounts",
                ethical_guidance: "Refund adjustments should be clearly explained and justified",
                consumer_rights: "Right to understand refund calculation methods",
                legal_notes: "Refund calculation methods must be transparent"
            },
            {
                query: "Should customers be able to transfer cashback to bank freely?",
                intent: "discount_inquiry",
                product_category: "general",
                purchase_type: "cashback",
                scenario: "Cashback transferability restrictions",
                ethical_guidance: "Transfer restrictions should be clearly disclosed upfront",
                consumer_rights: "Right to know cashback redemption limitations",
                legal_notes: "Cashback transfer terms must be clearly communicated"
            },

            // Shipping & Delivery (10 scenarios)
            {
                query: "Should sellers charge extra for express delivery even if standard is delayed?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Express delivery charges during standard delays",
                ethical_guidance: "Express charges should reflect genuine service differences",
                consumer_rights: "Right to delivery services as promised",
                legal_notes: "Charging extra for standard service failures may be unfair"
            },
            {
                query: "Is it fair to cancel COD orders without informing customer?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "cod",
                scenario: "Uninformed COD order cancellation",
                ethical_guidance: "Order cancellations require customer notification and explanation",
                consumer_rights: "Right to notification of order status changes",
                legal_notes: "Unilateral cancellations without notice may breach contract terms"
            },
            {
                query: "Should customers pay delivery fee if product is defective?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Delivery fee responsibility for defective products",
                ethical_guidance: "Defective product costs should not burden customers",
                consumer_rights: "Right to cost-free resolution of defective products",
                legal_notes: "Customer should not bear costs for seller's defective products"
            },
            {
                query: "Is it ethical to prioritize delivery for premium customers only?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Premium customer delivery prioritization",
                ethical_guidance: "Service tiers should be transparently communicated",
                consumer_rights: "Right to know service level differences",
                legal_notes: "Service differentiation must be clearly disclosed"
            },
            {
                query: "Should sellers disclose if delivery time shown is unrealistic?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Unrealistic delivery time disclosure",
                ethical_guidance: "Delivery estimates should be realistic and honest",
                consumer_rights: "Right to accurate delivery information",
                legal_notes: "Misleading delivery times may constitute false advertising"
            },
            {
                query: "Is it fair to charge hidden packaging fees at checkout?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Hidden packaging fee disclosure",
                ethical_guidance: "All fees should be disclosed upfront, not at checkout",
                consumer_rights: "Right to know complete costs before purchase decision",
                legal_notes: "Hidden fees at checkout may violate pricing transparency laws"
            },
            {
                query: "Should customers be compensated for late deliveries?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Late delivery compensation rights",
                ethical_guidance: "Compensation should match the impact of delivery delays",
                consumer_rights: "Right to timely delivery as promised",
                legal_notes: "Material delivery delays may require compensation"
            },
            {
                query: "Is it ethical to use unsafe packaging for fragile products?",
                intent: "consumer_rights",
                product_category: "fragile",
                purchase_type: "delivery",
                scenario: "Inadequate packaging for fragile items",
                ethical_guidance: "Packaging should match product needs and safety requirements",
                consumer_rights: "Right to receive products in undamaged condition",
                legal_notes: "Sellers liable for damage due to inadequate packaging"
            },
            {
                query: "Should delivery partners have the right to deny doorstep delivery?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Delivery partner service limitations",
                ethical_guidance: "Service limitations should be clearly communicated upfront",
                consumer_rights: "Right to receive ordered delivery services",
                legal_notes: "Delivery terms must match what was promised at purchase"
            },
            {
                query: "Is it fair to hide actual delivery charges in product price?",
                intent: "consumer_rights",
                product_category: "general",
                purchase_type: "delivery",
                scenario: "Hidden delivery costs in product pricing",
                ethical_guidance: "Pricing should be transparent with separate delivery costs",
                consumer_rights: "Right to transparent pricing breakdown",
                legal_notes: "Price manipulation to hide delivery costs may violate transparency laws"
            }
        ];

        // Initialize models with sample data
        async function initializeShoppingModels() {
            try {
                // Train models with sample data
                await shoppingModels.models.naive_bayes.trainWithSampleData();
                await shoppingModels.models.logistic.initializeWeights();
                await shoppingModels.models.lstm.loadPretrainedWeights();
                
                console.log('Shopping ML models initialized with sample data');
            } catch (error) {
                console.error('Failed to initialize shopping models:', error);
            }
        }

        // Shopping Mode Functions
        function toggleShoppingMode() {
            isShoppingMode = !isShoppingMode;
            const statusElement = document.getElementById('shopping-status');
            const apiProvider = document.getElementById('apiProvider');
            
            if (isShoppingMode) {
                statusElement.textContent = 'ON';
                statusElement.style.color = '#28a745';
                apiProvider.value = 'shopping';
                showShoppingWelcome();
            } else {
                statusElement.textContent = 'OFF';
                statusElement.style.color = '#6c757d';
                if (apiProvider.value === 'shopping') {
                    apiProvider.value = 'local';
                }
            }
        }

        function showShoppingWelcome() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="bot-avatar">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="welcome-content">
                        <h3>üõí Welcome to Shopping Ethics AI!</h3>
                        <p>I'm your intelligent shopping assistant powered by multiple ML models (LSTM, RNN, BERT, GRU, Naive Bayes, Logistic Regression). I can help you with:</p>
                        <div class="topic-cards">
                            <div class="topic-card" onclick="sendShoppingMessage('Can I return this item after 30 days?')">
                                <i class="fas fa-undo"></i>
                                <h4>Return Policies</h4>
                                <p>Learn about your return rights and processes</p>
                            </div>
                            <div class="topic-card" onclick="sendShoppingMessage('What is the exchange policy for discounted items?')">
                                <i class="fas fa-exchange-alt"></i>
                                <h4>Exchange Rights</h4>
                                <p>Understand exchange policies and your options</p>
                            </div>
                            <div class="topic-card" onclick="sendShoppingMessage('Is my warranty claim valid?')">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Warranty Claims</h4>
                                <p>Get guidance on warranty rights and claims</p>
                            </div>
                            <div class="topic-card" onclick="sendShoppingMessage('Are these discount terms ethical?')">
                                <i class="fas fa-percent"></i>
                                <h4>Discount Ethics</h4>
                                <p>Evaluate discount offers and terms</p>
                            </div>
                            <div class="topic-card" onclick="sendShoppingMessage('What are my rights with EMI purchases?')">
                                <i class="fas fa-credit-card"></i>
                                <h4>EMI & Payments</h4>
                                <p>Understand EMI terms and payment rights</p>
                            </div>
                            <div class="topic-card" onclick="sendShoppingMessage('What are my consumer rights?')">
                                <i class="fas fa-gavel"></i>
                                <h4>Consumer Rights</h4>
                                <p>Learn about legal protections and rights</p>
                            </div>
                        </div>
                        <p><strong>Current AI Model:</strong> <span id="current-model">Ensemble (All Models)</span></p>
                        <p>Ask me anything about ethical shopping, consumer rights, or product policies!</p>
                    </div>
                </div>
            `;
        }

        function sendShoppingMessage(message) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = message;
            
            // Ensure shopping mode is active
            if (!isShoppingMode) {
                toggleShoppingMode();
            }
            
            // Send the message
            if (window.ethicBot) {
                window.ethicBot.sendMessage();
            } else {
                console.error("EthicBot not initialized");
                alert("Please wait for the system to initialize and try again.");
            }
        }

        // Enhanced shopping mode toggle with error handling
        function toggleShoppingMode() {
            try {
                // Ensure isShoppingMode is defined
                if (typeof isShoppingMode === 'undefined') {
                    window.isShoppingMode = false;
                }
                
                isShoppingMode = !isShoppingMode;
                const statusElement = document.getElementById('shopping-status');
                const apiProvider = document.getElementById('apiProvider');
                
                if (isShoppingMode) {
                    if (statusElement) {
                        statusElement.textContent = 'ON';
                        statusElement.style.color = '#28a745';
                    }
                    if (apiProvider) {
                        apiProvider.value = 'shopping';
                    }
                    showShoppingWelcome();
                    
                    // Show activation message
                    if (window.ethicBot) {
                        setTimeout(() => {
                            window.ethicBot.addMessageToChat('bot', 
                                `üõí **Shopping Ethics AI Activated!**\n\n` +
                                `I'm now powered by 6 ML models trained on 70+ shopping scenarios.\n\n` +
                                `‚úÖ **Ready to help with:**\n` +
                                `‚Ä¢ Returns & Refunds\n‚Ä¢ Exchanges & Replacements\n‚Ä¢ Discount Ethics\n‚Ä¢ EMI & Payment Issues\n‚Ä¢ Consumer Rights\n‚Ä¢ Warranty Claims\n\n` +
                                `Ask me anything about ethical shopping practices!`
                            );
                        }, 500);
                    }
                } else {
                    if (statusElement) {
                        statusElement.textContent = 'OFF';
                        statusElement.style.color = '#6c757d';
                    }
                    if (apiProvider && apiProvider.value === 'shopping') {
                        apiProvider.value = 'local';
                    }
                    
                    // Show deactivation message
                    if (window.ethicBot) {
                        setTimeout(() => {
                            window.ethicBot.addMessageToChat('bot', 
                                `üîÑ **Shopping Mode Deactivated**\n\n` +
                                `Switched back to general AI ethics mode. I can still help with shopping questions!`
                            );
                        }, 500);
                    }
                }
                
                console.log("Shopping mode toggled:", isShoppingMode);
                
            } catch (error) {
                console.error("Error toggling shopping mode:", error);
                alert("Error toggling shopping mode. Please refresh the page.");
            }
        }

        // Test Questions for Shopping Ethics AI
        const testQuestions = [
            "If I bought this item with 10% off, is it ethical for the seller to deny returns?",
            "Is it fair to apply exchange offer rules differently for old vs. new customers?",
            "Can a seller refuse a refund if the product arrived damaged?",
            "Is it ethical to advertise cashback but not mention hidden conditions?",
            "Should a buyer be told clearly about a no return policy before purchase?",
            "If I use Buy 1 Get 1 free, should both items be covered under warranty?",
            "Is it fair for a shop to deny exchange on discounted products?",
            "If a product bought on EMI is defective, should the buyer still pay installments?",
            "Should flash sale prices be the same for all customers, or only app users?",
            "If a seller delays a replacement, is it ethical to charge the customer again?",
            "Is it right for stores to refuse gift wrapping on low-cost items?",
            "Should customers be informed if a return period is shorter for discounted goods?",
            "Is it ethical to reject a refund when an item is out of stock for replacement?",
            "Should exchange offers be valid across all categories, or limited ones?",
            "Is it fair to cancel orders in a flash sale after charging customers?",
            "If I use a cashback offer, can the store reduce my refund later?",
            "Should damaged items be replaced even if bought in a clearance sale?",
            "Can sellers ethically put a no return policy on essential goods?",
            "Should EMI plans disclose interest rates more transparently?",
            "Is it right for a shop to remove warranty when product is bought at discount?",
            "If I buy two items under BOGO and one is faulty, should both be replaced?",
            "Is it ethical for sellers to force store credit refunds instead of money?",
            "Should sellers clearly state when exchange is only for size/color and not defects?",
            "If a product was gift wrapped, should it still be eligible for returns?",
            "Is it fair to charge customers extra fees during return pickup?",
            "Should customers be compensated if they don't get promised cashback?",
            "Is it ethical to sell a refurbished product without informing the customer?",
            "Should all items in a bundle deal be eligible for individual returns?",
            "Is it fair for sellers to change return policy after purchase?",
            "Can a shop deny warranty on items bought during flash sales?",
            "Should exchange offers clearly state the valuation method of old items?",
            "Is it ethical for platforms to hide cheaper options from other sellers?",
            "If I buy on EMI, should I still pay EMI if the seller cancels the order?",
            "Should damaged packaging be a valid reason for return?",
            "Is it fair to restrict free delivery to only full-price products?",
            "Can a seller legally refuse refunds and only allow exchanges?",
            "Should customers be compensated if an item bought on discount never ships?",
            "Is it ethical to run fake flash sales with limited stock just for marketing?",
            "Should customers be warned about non-refundable handling charges before purchase?",
            "Is it fair for a store to keep the buyer waiting for weeks in case of damaged item replacement?"
        ];

        // Test Functions
        function runRandomTest() {
            const randomQuestion = testQuestions[Math.floor(Math.random() * testQuestions.length)];
            sendShoppingMessage(randomQuestion);
        }

        function showTestQuestions() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="test-questions-panel">
                    <div class="test-header">
                        <h2>üß™ Test Shopping Ethics AI</h2>
                        <p>Try these real-world shopping scenarios to test the AI's capabilities</p>
                        <button onclick="runRandomTest()" class="random-test-btn">
                            <i class="fas fa-random"></i> Random Test Question
                        </button>
                    </div>

                    <div class="test-categories">
                        <div class="test-category">
                            <h3><i class="fas fa-percent"></i> Discount & Offer Ethics</h3>
                            <div class="test-questions">
                                <button onclick="sendShoppingMessage('If I bought this item with 10% off, is it ethical for the seller to deny returns?')" class="test-btn">
                                    10% off return denial ethics
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair to apply exchange offer rules differently for old vs. new customers?')" class="test-btn">
                                    Different rules for customers
                                </button>
                                <button onclick="sendShoppingMessage('Is it ethical to advertise cashback but not mention hidden conditions?')" class="test-btn">
                                    Hidden cashback conditions
                                </button>
                                <button onclick="sendShoppingMessage('Should flash sale prices be the same for all customers, or only app users?')" class="test-btn">
                                    Flash sale fairness
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair to cancel orders in a flash sale after charging customers?')" class="test-btn">
                                    Flash sale cancellations
                                </button>
                            </div>
                        </div>

                        <div class="test-category">
                            <h3><i class="fas fa-undo"></i> Return & Refund Ethics</h3>
                            <div class="test-questions">
                                <button onclick="sendShoppingMessage('Can a seller refuse a refund if the product arrived damaged?')" class="test-btn">
                                    Damaged product refusal
                                </button>
                                <button onclick="sendShoppingMessage('Should a buyer be told clearly about a no return policy before purchase?')" class="test-btn">
                                    Clear return policy disclosure
                                </button>
                                <button onclick="sendShoppingMessage('Is it ethical to reject a refund when an item is out of stock for replacement?')" class="test-btn">
                                    Out of stock refund rejection
                                </button>
                                <button onclick="sendShoppingMessage('Is it ethical for sellers to force store credit refunds instead of money?')" class="test-btn">
                                    Store credit vs money refund
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair for sellers to change return policy after purchase?')" class="test-btn">
                                    Post-purchase policy changes
                                </button>
                            </div>
                        </div>

                        <div class="test-category">
                            <h3><i class="fas fa-exchange-alt"></i> Exchange & Warranty Ethics</h3>
                            <div class="test-questions">
                                <button onclick="sendShoppingMessage('If I use Buy 1 Get 1 free, should both items be covered under warranty?')" class="test-btn">
                                    BOGO warranty coverage
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair for a shop to deny exchange on discounted products?')" class="test-btn">
                                    Discounted product exchanges
                                </button>
                                <button onclick="sendShoppingMessage('Should exchange offers be valid across all categories, or limited ones?')" class="test-btn">
                                    Exchange offer limitations
                                </button>
                                <button onclick="sendShoppingMessage('Is it right for a shop to remove warranty when product is bought at discount?')" class="test-btn">
                                    Discount warranty removal
                                </button>
                                <button onclick="sendShoppingMessage('Can a shop deny warranty on items bought during flash sales?')" class="test-btn">
                                    Flash sale warranty denial
                                </button>
                            </div>
                        </div>

                        <div class="test-category">
                            <h3><i class="fas fa-credit-card"></i> EMI & Payment Ethics</h3>
                            <div class="test-questions">
                                <button onclick="sendShoppingMessage('If a product bought on EMI is defective, should the buyer still pay installments?')" class="test-btn">
                                    Defective EMI product payments
                                </button>
                                <button onclick="sendShoppingMessage('Should EMI plans disclose interest rates more transparently?')" class="test-btn">
                                    EMI transparency requirements
                                </button>
                                <button onclick="sendShoppingMessage('If I buy on EMI, should I still pay EMI if the seller cancels the order?')" class="test-btn">
                                    Cancelled EMI order payments
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair to charge customers extra fees during return pickup?')" class="test-btn">
                                    Return pickup fee ethics
                                </button>
                                <button onclick="sendShoppingMessage('Should customers be warned about non-refundable handling charges before purchase?')" class="test-btn">
                                    Hidden handling charges
                                </button>
                            </div>
                        </div>

                        <div class="test-category">
                            <h3><i class="fas fa-shield-alt"></i> Consumer Rights & Fairness</h3>
                            <div class="test-questions">
                                <button onclick="sendShoppingMessage('Can sellers ethically put a no return policy on essential goods?')" class="test-btn">
                                    Essential goods return policy
                                </button>
                                <button onclick="sendShoppingMessage('Is it ethical to sell a refurbished product without informing the customer?')" class="test-btn">
                                    Undisclosed refurbished products
                                </button>
                                <button onclick="sendShoppingMessage('Should all items in a bundle deal be eligible for individual returns?')" class="test-btn">
                                    Bundle deal return rights
                                </button>
                                <button onclick="sendShoppingMessage('Is it ethical for platforms to hide cheaper options from other sellers?')" class="test-btn">
                                    Platform price manipulation
                                </button>
                                <button onclick="sendShoppingMessage('Is it ethical to run fake flash sales with limited stock just for marketing?')" class="test-btn">
                                    Fake flash sale marketing
                                </button>
                            </div>
                        </div>

                        <div class="test-category">
                            <h3><i class="fas fa-gift"></i> Special Scenarios</h3>
                            <div class="test-questions">
                                <button onclick="sendShoppingMessage('If a product was gift wrapped, should it still be eligible for returns?')" class="test-btn">
                                    Gift wrapped return eligibility
                                </button>
                                <button onclick="sendShoppingMessage('Should damaged packaging be a valid reason for return?')" class="test-btn">
                                    Damaged packaging returns
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair to restrict free delivery to only full-price products?')" class="test-btn">
                                    Free delivery restrictions
                                </button>
                                <button onclick="sendShoppingMessage('Should customers be compensated if an item bought on discount never ships?')" class="test-btn">
                                    Discount item shipping failure
                                </button>
                                <button onclick="sendShoppingMessage('Is it fair for a store to keep the buyer waiting for weeks in case of damaged item replacement?')" class="test-btn">
                                    Replacement delay ethics
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="test-footer">
                        <h3>üéØ Testing Instructions</h3>
                        <div class="instructions">
                            <p><strong>1. Activate Shopping Mode:</strong> Make sure Shopping Mode is ON (toggle in sidebar)</p>
                            <p><strong>2. Choose Model:</strong> Try "Ensemble" for best results, or test individual models</p>
                            <p><strong>3. Click Test Questions:</strong> Each button will ask the AI a specific ethical scenario</p>
                            <p><strong>4. Analyze Responses:</strong> Look for intent classification, model voting, ethics guidance</p>
                            <p><strong>5. Compare Models:</strong> Try the same question with different AI models</p>
                        </div>
                        <div class="test-actions">
                            <button onclick="toggleShoppingMode()" class="activate-btn">
                                <i class="fas fa-shopping-cart"></i> Activate Shopping Mode
                            </button>
                            <button onclick="runRandomTest()" class="random-btn">
                                <i class="fas fa-dice"></i> Surprise Me!
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="user-guide">
                    <div class="guide-header">
                        <h2>üìö Shopping Ethics AI - Complete User Guide</h2>
                        <p>Learn how to use all features of your AI-powered shopping assistant</p>
                    </div>

                    <div class="guide-section">
                        <h3>üöÄ Getting Started</h3>
                        <div class="guide-steps">
                            <div class="step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <h4>Activate Shopping Mode</h4>
                                    <p>Click the <strong>"Shopping Mode"</strong> button in the sidebar or select <strong>"Shopping Assistant"</strong> from the AI Provider dropdown.</p>
                                    <button onclick="toggleShoppingMode()" class="demo-btn">Try: Toggle Shopping Mode</button>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <h4>Ask Your Question</h4>
                                    <p>Type any shopping-related question in the message box. The AI will analyze it using 6 different ML models.</p>
                                    <button onclick="sendShoppingMessage('Can I return this item after 30 days?')" class="demo-btn">Try: Sample Return Question</button>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <h4>Get Comprehensive Guidance</h4>
                                    <p>Receive ethical guidance, consumer rights information, and practical recommendations.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>üß† AI Models Explained</h3>
                        <div class="model-grid">
                            <div class="model-card">
                                <h4><i class="fas fa-brain"></i> LSTM</h4>
                                <p><strong>Best for:</strong> Understanding context and sequences in your questions</p>
                                <p><strong>Weight:</strong> 25% of final decision</p>
                            </div>
                            <div class="model-card">
                                <h4><i class="fas fa-robot"></i> BERT</h4>
                                <p><strong>Best for:</strong> Deep language understanding and meaning</p>
                                <p><strong>Weight:</strong> 30% of final decision (highest)</p>
                            </div>
                            <div class="model-card">
                                <h4><i class="fas fa-network-wired"></i> GRU</h4>
                                <p><strong>Best for:</strong> Efficient processing of your text</p>
                                <p><strong>Weight:</strong> 20% of final decision</p>
                            </div>
                            <div class="model-card">
                                <h4><i class="fas fa-chart-line"></i> Naive Bayes</h4>
                                <p><strong>Best for:</strong> Probability-based text classification</p>
                                <p><strong>Weight:</strong> 10% of final decision</p>
                            </div>
                            <div class="model-card">
                                <h4><i class="fas fa-calculator"></i> Logistic Regression</h4>
                                <p><strong>Best for:</strong> Linear classification and keyword analysis</p>
                                <p><strong>Weight:</strong> 10% of final decision</p>
                            </div>
                            <div class="model-card">
                                <h4><i class="fas fa-share-alt"></i> Simple RNN</h4>
                                <p><strong>Best for:</strong> Basic sequence processing</p>
                                <p><strong>Weight:</strong> 5% of final decision</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>üéØ Types of Questions You Can Ask</h3>
                        <div class="question-types">
                            <div class="question-type">
                                <h4><i class="fas fa-undo"></i> Return Policy</h4>
                                <p>Questions about returning products, time limits, conditions</p>
                                <div class="examples">
                                    <button onclick="sendShoppingMessage('Can I return this laptop after 15 days?')" class="example-btn">Example: Laptop Return</button>
                                    <button onclick="sendShoppingMessage('What if I lost the original packaging?')" class="example-btn">Example: No Packaging</button>
                                </div>
                            </div>
                            <div class="question-type">
                                <h4><i class="fas fa-exchange-alt"></i> Exchange Policy</h4>
                                <p>Information about exchanging products, size changes, defects</p>
                                <div class="examples">
                                    <button onclick="sendShoppingMessage('Can I exchange this discounted shirt?')" class="example-btn">Example: Discounted Item</button>
                                    <button onclick="sendShoppingMessage('Exchange policy for wrong size?')" class="example-btn">Example: Wrong Size</button>
                                </div>
                            </div>
                            <div class="question-type">
                                <h4><i class="fas fa-shield-alt"></i> Warranty Claims</h4>
                                <p>Warranty rights, claim processes, manufacturer obligations</p>
                                <div class="examples">
                                    <button onclick="sendShoppingMessage('My phone warranty claim was rejected')" class="example-btn">Example: Rejected Claim</button>
                                    <button onclick="sendShoppingMessage('How long is the warranty period?')" class="example-btn">Example: Warranty Period</button>
                                </div>
                            </div>
                            <div class="question-type">
                                <h4><i class="fas fa-percent"></i> Discount Verification</h4>
                                <p>Checking if discounts are genuine, terms and conditions</p>
                                <div class="examples">
                                    <button onclick="sendShoppingMessage('Is this 70% off deal too good to be true?')" class="example-btn">Example: Discount Check</button>
                                    <button onclick="sendShoppingMessage('Hidden terms in sale offers?')" class="example-btn">Example: Hidden Terms</button>
                                </div>
                            </div>
                            <div class="question-type">
                                <h4><i class="fas fa-credit-card"></i> EMI & Payments</h4>
                                <p>EMI terms, interest rates, payment rights, cancellation</p>
                                <div class="examples">
                                    <button onclick="sendShoppingMessage('Can I cancel my EMI plan early?')" class="example-btn">Example: EMI Cancellation</button>
                                    <button onclick="sendShoppingMessage('Hidden charges in EMI?')" class="example-btn">Example: Hidden Charges</button>
                                </div>
                            </div>
                            <div class="question-type">
                                <h4><i class="fas fa-gavel"></i> Consumer Rights</h4>
                                <p>Legal protections, fraud concerns, general rights</p>
                                <div class="examples">
                                    <button onclick="sendShoppingMessage('What are my rights as a consumer?')" class="example-btn">Example: General Rights</button>
                                    <button onclick="sendShoppingMessage('I received a fake product')" class="example-btn">Example: Fraud</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>üìä Understanding AI Responses</h3>
                        <div class="response-breakdown">
                            <div class="response-part">
                                <h4>üéØ Intent Classification</h4>
                                <p>Shows what type of question the AI thinks you're asking (e.g., "return_policy") with confidence percentage.</p>
                            </div>
                            <div class="response-part">
                                <h4>üß† Model Breakdown</h4>
                                <p>When using "Ensemble" mode, see how each of the 6 AI models voted and their confidence levels.</p>
                            </div>
                            <div class="response-part">
                                <h4>üõ°Ô∏è Consumer Rights</h4>
                                <p>Legal protections and rights relevant to your situation, based on consumer protection laws.</p>
                            </div>
                            <div class="response-part">
                                <h4>‚öñÔ∏è Ethical Guidance</h4>
                                <p>Moral considerations and ethical advice for making responsible shopping decisions.</p>
                            </div>
                            <div class="response-part">
                                <h4>üìã Legal Reminders</h4>
                                <p>Important legal information and reminders about your rights and protections.</p>
                            </div>
                            <div class="response-part">
                                <h4>üìù Recommendations</h4>
                                <p>Practical, actionable steps you can take to resolve your shopping concern.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>‚öôÔ∏è Advanced Features</h3>
                        <div class="features-grid">
                            <div class="feature">
                                <h4><i class="fas fa-layer-group"></i> Model Selection</h4>
                                <p>Switch between individual AI models or use "Ensemble" for best results. Try different models to see how they handle the same question differently.</p>
                            </div>
                            <div class="feature">
                                <h4><i class="fas fa-eye"></i> Transparency</h4>
                                <p>See exactly how the AI makes decisions. View confidence scores and model voting breakdowns for complete transparency.</p>
                            </div>
                            <div class="feature">
                                <h4><i class="fas fa-memory"></i> Context Awareness</h4>
                                <p>The AI remembers your conversation context to provide more relevant and personalized responses.</p>
                            </div>
                            <div class="feature">
                                <h4><i class="fas fa-shield-alt"></i> Ethics Priority</h4>
                                <p>Unlike regular shopping assistants, this AI prioritizes your rights and ethical considerations in every response.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>üí° Tips for Best Results</h3>
                        <div class="tips">
                            <div class="tip">
                                <h4>‚úÖ Be Specific</h4>
                                <p>Include details like product type, purchase date, or specific concerns for more targeted advice.</p>
                                <p><strong>Good:</strong> "Can I return this electronics item bought 20 days ago?"</p>
                                <p><strong>Better:</strong> "Can I return this laptop I bought 20 days ago that has screen issues?"</p>
                            </div>
                            <div class="tip">
                                <h4>‚úÖ Use Ensemble Mode</h4>
                                <p>The "Ensemble" option combines all 6 AI models for the most accurate and comprehensive responses.</p>
                            </div>
                            <div class="tip">
                                <h4>‚úÖ Ask Follow-up Questions</h4>
                                <p>The AI maintains context, so you can ask follow-up questions for deeper understanding.</p>
                            </div>
                            <div class="tip">
                                <h4>‚úÖ Compare Model Responses</h4>
                                <p>Try asking the same question with different individual models to see different AI perspectives.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>‚ö†Ô∏è Important Disclaimers</h3>
                        <div class="disclaimers">
                            <div class="disclaimer">
                                <h4><i class="fas fa-exclamation-triangle"></i> Not Legal Advice</h4>
                                <p>AI responses are for guidance only. For complex legal issues, consult with qualified legal professionals or consumer protection agencies.</p>
                            </div>
                            <div class="disclaimer">
                                <h4><i class="fas fa-info-circle"></i> General Guidance</h4>
                                <p>Advice is based on common consumer protection principles. Specific policies may vary by seller, region, and product type.</p>
                            </div>
                            <div class="disclaimer">
                                <h4><i class="fas fa-clock"></i> Keep Documentation</h4>
                                <p>Always keep receipts, warranty cards, and communication records for any shopping-related issues.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-footer">
                        <h3>üöÄ Ready to Start?</h3>
                        <p>Now that you understand how Shopping Ethics AI works, activate Shopping Mode and start asking your questions!</p>
                        <div class="action-buttons">
                            <button onclick="toggleShoppingMode()" class="primary-btn">
                                <i class="fas fa-shopping-cart"></i> Activate Shopping Mode
                            </button>
                            <button onclick="sendShoppingMessage('What are my consumer rights?')" class="secondary-btn">
                                <i class="fas fa-play"></i> Try Sample Question
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Override the original message handling for shopping mode
        const originalSendMessage = window.ethicBot?.sendMessage;
        
        // Enhanced message processing for shopping mode
        async function processShoppingMessage(message) {
            if (!isShoppingMode) return null;
            
            try {
                // Extract product context (you could add UI for this)
                const productInfo = {
                    category: '', // Could be extracted from message or UI
                    purchaseType: '', // Could be extracted from message or UI
                };
                
                // Classify intent using ML models
                const classification = await shoppingModels.classifyIntent(message, productInfo);
                
                // Generate response with ethics guidance
                const responseData = await shoppingModels.generateResponse(
                    classification.intent, 
                    message, 
                    productInfo
                );
                
                // Add model breakdown for transparency
                let response = responseData.response;
                
                if (classification.modelBreakdown) {
                    response += `\n\n**üß† AI Model Analysis:**\n`;
                    response += `‚Ä¢ **Primary Intent:** ${classification.intent} (Confidence: ${(classification.confidence * 100).toFixed(1)}%)\n`;
                    response += `‚Ä¢ **Model Used:** ${currentShoppingModel === 'ensemble' ? 'Ensemble of 6 ML models' : currentShoppingModel.toUpperCase()}\n`;
                    
                    if (currentShoppingModel === 'ensemble') {
                        response += `‚Ä¢ **Model Breakdown:**\n`;
                        Object.entries(classification.modelBreakdown).forEach(([model, pred]) => {
                            response += `  - ${model.toUpperCase()}: ${pred.intent} (${(pred.confidence * 100).toFixed(1)}%)\n`;
                        });
                    }
                }
                
                // Add recommendations
                if (responseData.recommendations.length > 0) {
                    response += `\n\n**üìù Recommendations:**\n`;
                    response += responseData.recommendations.map(rec => `‚Ä¢ ${rec}`).join('\n');
                }
                
                return response;
                
            } catch (error) {
                console.error('Shopping ML processing failed:', error);
                return `I apologize, but I encountered an issue processing your shopping query. Please try rephrasing your question, and I'll do my best to help you with ethical shopping guidance.`;
            }
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded - Initializing EthicBot");
            
            try {
                // Update server status first
                updateServerStatus();
                
                // Initialize the main EthicBot
                window.ethicBot = new EthicBot();
                console.log("‚úÖ EthicBot initialized successfully");
                
                // Initialize shopping mode variables
                if (typeof window.isShoppingMode === 'undefined') {
                    window.isShoppingMode = false;
                }
                
                // Show welcome message with enhanced capabilities
                setTimeout(() => {
                    if (window.ethicBot) {
                        const serverType = window.location.protocol === 'file:' ? 'File System' : 
                                         (window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')) ? 'Localhost Server' : 'Remote Server';
                        
                        window.ethicBot.addMessageToChat('bot', 
                            `ü§ñ **EthicBot Enhanced - Ready!**\n\n` +
                            `‚úÖ **Environment:** ${serverType}\n` +
                            `‚úÖ **Features Active:**\n` +
                            `‚Ä¢ Smart AI Chat: Type any question and I'll respond\n` +
                            `‚Ä¢ Shopping AI: 70+ scenarios with 6 ML models\n` +
                            `‚Ä¢ Auto-Detection: Shopping queries automatically routed\n` +
                            `‚Ä¢ Consumer Rights: Legal guidance and ethics analysis\n\n` +
                            
                            `üõí **Try asking:** "Can I return this item?"\n` +
                            `‚öñÔ∏è **Or ask about:** AI ethics, bias, fairness, transparency\n\n` +
                            
                            `üí° **Test:** Type "hello" to verify chat is working!\n\n` +
                            
                            `${window.location.protocol === 'file:' ? 
                                `üåê **For better performance:** Click "Localhost Setup" button above to run on a local server!` :
                                `üöÄ **Running optimally!** ${window.location.hostname.includes('localhost') ? 'Localhost server detected.' : 'Remote server active.'}`
                            }`
                        );
                    }
                }, 1000);
                
                // Initialize shopping models in background
                initializeShoppingModels().then(() => {
                    console.log("‚úÖ Shopping Ethics AI fully initialized");
                }).catch(error => {
                    console.warn("‚ö†Ô∏è Shopping AI initialization failed:", error);
                });
                
                console.log("‚úÖ Initialization complete");
                
            } catch (error) {
                console.error("‚ùå Initialization failed:", error);
                alert("Failed to initialize EthicBot: " + error.message);
            }
        });

        // Create query type indicator
        function createQueryIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'query-type-indicator';
            indicator.style.cssText = `
                background: #e3f2fd;
                border: 1px solid #2196f3;
                border-radius: 8px;
                padding: 8px 12px;
                margin: 5px 0;
                font-size: 14px;
                color: #1976d2;
                display: none;
            `;
            
            const chatInput = document.querySelector('.chat-input');
            if (chatInput) {
                chatInput.insertBefore(indicator, chatInput.firstChild);
            }
            
            return indicator;
        }
                    
                    // Process with shopping AI
                    try {
                        const response = await processShoppingMessage(message);
                        thinkingDiv.remove();
                        
                        if (response) {
                            this.addMessageToChat('bot', response);
        // CSS for shopping mode
        const shoppingStyles = `
            .shopping-toggle-btn {
                width: 100%;
                padding: 8px 12px;
                background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .shopping-toggle-btn:hover {
                background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            }
            
            .topic-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }
            
            .topic-card {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border: 1px solid #dee2e6;
                border-radius: 10px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
            }
            
            .topic-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            }
            
            .topic-card i {
                font-size: 2rem;
                color: #007bff;
                margin-bottom: 10px;
            }
            
            .topic-card h4 {
                margin: 10px 0 8px 0;
                color: #343a40;
                font-size: 1.1rem;
            }
            
            .topic-card p {
                margin: 0;
                color: #6c757d;
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .thinking-animation {
                display: flex;
                align-items: center;
                gap: 10px;
                color: #17a2b8;
                font-style: italic;
            }
            
            .thinking-animation::before {
                content: '';
                width: 16px;
                height: 16px;
                border: 2px solid #17a2b8;
                border-radius: 50%;
                border-right-color: transparent;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            
            .guide-btn {
                width: 100%;
                padding: 8px 12px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .guide-btn:hover {
                background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            }
            
            .test-btn-sidebar {
                width: 100%;
                padding: 8px 12px;
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .test-btn-sidebar:hover {
                background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            }
            
            /* Test Questions Panel Styles */
            .test-questions-panel {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            
            .test-header {
                text-align: center;
                margin-bottom: 30px;
                padding: 20px;
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                border-radius: 12px;
            }
            
            .test-header h2 {
                margin: 0 0 10px 0;
                font-size: 1.8rem;
            }
            
            .random-test-btn {
                background: rgba(255,255,255,0.2);
                color: white;
                border: 1px solid white;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                margin-top: 15px;
                transition: all 0.3s ease;
            }
            
            .random-test-btn:hover {
                background: rgba(255,255,255,0.3);
                transform: translateY(-2px);
            }
            
            .test-categories {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .test-category {
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                border-left: 4px solid #dc3545;
            }
            
            .test-category h3 {
                margin: 0 0 15px 0;
                color: #333;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 1.1rem;
            }
            
            .test-category i {
                color: #dc3545;
            }
            
            .test-questions {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .test-btn {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border: 1px solid #dee2e6;
                color: #495057;
                padding: 10px 15px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: left;
                font-size: 13px;
                line-height: 1.3;
            }
            
            .test-btn:hover {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                transform: translateX(5px);
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            }
            
            .test-footer {
                background: #f8f9fa;
                padding: 25px;
                border-radius: 12px;
                border: 1px solid #dee2e6;
            }
            
            .test-footer h3 {
                margin: 0 0 15px 0;
                color: #333;
                text-align: center;
            }
            
            .instructions {
                margin-bottom: 20px;
            }
            
            .instructions p {
                margin: 8px 0;
                color: #666;
                line-height: 1.5;
            }
            
            .test-actions {
                display: flex;
                justify-content: center;
                gap: 15px;
                flex-wrap: wrap;
            }
            
            .activate-btn {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .activate-btn:hover {
                background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
                transform: translateY(-2px);
            }
            
            .random-btn {
                background: linear-gradient(135deg, #6f42c1 0%, #6610f2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .random-btn:hover {
                background: linear-gradient(135deg, #6610f2 0%, #5a2d91 100%);
                transform: translateY(-2px);
            }
            
            @media (max-width: 768px) {
                .test-questions-panel {
                    padding: 15px;
                }
                
                .test-categories {
                    grid-template-columns: 1fr;
                }
                
                .test-actions {
                    flex-direction: column;
                    align-items: center;
                }
            }
            
            /* User Guide Styles */
            .user-guide {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            
            .guide-header {
                text-align: center;
                margin-bottom: 30px;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 12px;
            }
            
            .guide-header h2 {
                margin: 0 0 10px 0;
                font-size: 1.8rem;
            }
            
            .guide-section {
                margin-bottom: 30px;
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .guide-section h3 {
                color: #333;
                border-bottom: 2px solid #007bff;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            .guide-steps {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            
            .step {
                display: flex;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #007bff;
            }
            
            .step-number {
                background: #007bff;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                flex-shrink: 0;
            }
            
            .step-content h4 {
                margin: 0 0 8px 0;
                color: #333;
            }
            
            .step-content p {
                margin: 0 0 10px 0;
                color: #666;
                line-height: 1.5;
            }
            
            .demo-btn, .example-btn {
                background: #17a2b8;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .demo-btn:hover, .example-btn:hover {
                background: #138496;
                transform: translateY(-1px);
            }
            
            .model-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
            }
            
            .model-card {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                transition: transform 0.2s ease;
            }
            
            .model-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .model-card h4 {
                margin: 0 0 10px 0;
                color: #333;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .model-card i {
                color: #007bff;
            }
            
            .model-card p {
                margin: 5px 0;
                font-size: 14px;
                line-height: 1.4;
            }
            
            .question-types {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
            
            .question-type {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                border-left: 4px solid #28a745;
            }
            
            .question-type h4 {
                margin: 0 0 10px 0;
                color: #333;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .question-type i {
                color: #28a745;
            }
            
            .examples {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 10px;
            }
            
            .response-breakdown {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
            
            .response-part {
                background: #e3f2fd;
                border-radius: 8px;
                padding: 15px;
                border-left: 4px solid #2196f3;
            }
            
            .response-part h4 {
                margin: 0 0 8px 0;
                color: #1976d2;
            }
            
            .features-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .feature {
                background: #fff3cd;
                border-radius: 8px;
                padding: 15px;
                border-left: 4px solid #ffc107;
            }
            
            .feature h4 {
                margin: 0 0 8px 0;
                color: #856404;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .feature i {
                color: #ffc107;
            }
            
            .tips {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .tip {
                background: #d4edda;
                border-radius: 8px;
                padding: 15px;
                border-left: 4px solid #28a745;
            }
            
            .tip h4 {
                margin: 0 0 8px 0;
                color: #155724;
            }
            
            .tip p {
                margin: 5px 0;
                line-height: 1.4;
            }
            
            .disclaimers {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .disclaimer {
                background: #f8d7da;
                border-radius: 8px;
                padding: 15px;
                border-left: 4px solid #dc3545;
            }
            
            .disclaimer h4 {
                margin: 0 0 8px 0;
                color: #721c24;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .disclaimer i {
                color: #dc3545;
            }
            
            .guide-footer {
                text-align: center;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 25px;
                border-radius: 12px;
                margin-top: 30px;
            }
            
            .action-buttons {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin-top: 15px;
                flex-wrap: wrap;
            }
            
            .primary-btn, .secondary-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .primary-btn {
                background: white;
                color: #28a745;
            }
            
            .primary-btn:hover {
                background: #f8f9fa;
                transform: translateY(-2px);
            }
            
            .secondary-btn {
                background: rgba(255,255,255,0.2);
                color: white;
                border: 1px solid white;
            }
            
            .secondary-btn:hover {
                background: rgba(255,255,255,0.3);
                transform: translateY(-2px);
            }
            
            @media (max-width: 768px) {
                .user-guide {
                    padding: 15px;
                }
                
                .model-grid, .question-types, .response-breakdown, .features-grid {
                    grid-template-columns: 1fr;
                }
                
                .action-buttons {
                    flex-direction: column;
                    align-items: center;
                }
            }
        `;
        
        // Add styles to page
        const styleSheet = document.createElement('style');
        styleSheet.textContent = shoppingStyles;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
